var QueryString=function(){for(var e={},n=window.location.search.substring(1).split("&"),t=0;t<n.length;t++){var o=n[t].split("=");if(void 0===e[o[0]])e[o[0]]=o[1];else if("string"==typeof e[o[0]]){var i=[e[o[0]],o[1]];e[o[0]]=i}else e[o[0]].push(o[1])}return e},useragent=(navigator.userAgent||navigator.vendor||window.opera).toLowerCase(),isiPhone=/iPhone|iPad|iPod/i.test(useragent)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1,isAndroid=/android/i.test(useragent),isWindowsPhone=/windows phone/i.test(useragent),isOpera=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,isFirefox="undefined"!=typeof InstallTrigger,queryString=QueryString(),isSafariA=(!queryString.isSafari||"false"!=queryString.isSafari)&&(Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||"[object SafariRemoteNotification]"===(!window.safari||safari.pushNotification).toString()),isChrome=!!window.chrome&&!isOpera,isIEA=(!queryString.isIE||"false"!=queryString.isIE)&&!!document.documentMode,isEdge=(!queryString.isEdge||"false"!=queryString.isEdge)&&navigator.userAgent.indexOf("Edge")>-1;function getChromeVersion(){var e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);return!!e&&parseInt(e[2],10)}function loadScript(e,n){var t=document.createElement("script");t.type="text/javascript",t.readyState?t.onreadystatechange=function(){"loaded"!=t.readyState&&"complete"!=t.readyState||(t.onreadystatechange=null,n&&n())}:t.onload=function(){n&&n()},t.onerror=function(t){setTimeout(function(){loadScript(e,n)},5e3)},t.src=e+"?v="+currVersion,document.getElementsByTagName("head")[0].appendChild(t)}function stopFullScreenPopup(){document.getElementById("exitFullscreenButton")&&(document.getElementById("exitFullscreenButton").style.display="none"),document.getElementById("fullscreenButton")&&(document.getElementById("fullscreenButton").style.display="block"),window.resizeTo(widgetSize.width+(window.outerWidth-window.innerWidth),widgetSize.height+(window.outerHeight-window.innerHeight)),window.moveTo((screen.width-widgetSize.width)/2,(screen.height-widgetSize.height)/2)}function toggleFullScreen(){document.msFullscreenElement||document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen?stopFullScreen():showFullScreen()}function showFullScreen(){var e=document.getElementById("video_container");e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(),document.getElementById("exitFullscreenButton").style.display="block"}function stopFullScreen(){document.fullscreen&&document.exitFullscreen?document.exitFullscreen():document.fullscreen&&document.msExitFullscreen?document.msExitFullscreen():document.fullscreen&&document.mozCancelFullScreen?document.mozCancelFullScreen():document.fullscreen&&document.webkitCancelFullScreen&&document.webkitCancelFullScreen(),document.getElementById("exitFullscreenButton")&&(document.getElementById("exitFullscreenButton").style.display="none")}function changeToUrl(e){for(var n=e,t=new RegExp(/[-a-zA-Z0-9@:%_\+.~#?&\/\/=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&\/\/=]*)?/gi),o=n.split(" "),i=0;i<o.length;i++)o[i].match(t)&&(o[i]='<a target="_blank" href="'+o[i]+'">'+o[i]+"</a>");return o.join(" ")}document.addEventListener("fullscreenchange",function(){document.fullscreen||stopFullScreen()},!1),document.addEventListener("mozfullscreenchange",function(){document.mozFullScreen||stopFullScreen()},!1),document.addEventListener("MSFullscreenChange",function(){document.msFullscreenElement||stopFullScreen()},!1),document.addEventListener("webkitfullscreenchange",function(){document.webkitIsFullScreen||stopFullScreen()},!1);var prevId,prevMsgP,prevBody,errorTimer,incomingAudio,incomingMessage,enterRoom,estimateDif=function(e){var n=parseInt(e/1e3,10),t=Math.floor(n/3600),o=Math.floor((n-3600*t)/60),i=n-3600*t-60*o;return t||o||i?(t=t?t+(1==t?" hour ":" hours "):"")+(o=o?o+(1==o?" minute ":" minutes "):"")+(i=i?i+(1==i?" second ":" seconds "):""):null},generateLink=function(e){sessionId=Math.random().toString(36).slice(2).substring(0,15);var n={};if(lsRepUrl&&(n.lsRepUrl=lsRepUrl),$("#roomName").val()&&(sessionId=$("#roomName").val()),$("#names").val()&&(n.names=$("#names").val()),agentId&&(n.agentId=agentId),$("#visitorName").val()&&(n.visitorName=$("#visitorName").val()),$("#config").val()&&(n.config=$("#config").val()),$("#shortvisitor").val()?(shortVisitorUrl=$("#shortvisitor").val(),shortVisitorUrl_broadcast=$("#shortvisitor").val()+"_b"):(shortVisitorUrl=Math.random().toString(36).slice(2).substring(0,6),shortVisitorUrl_broadcast=Math.random().toString(36).slice(2).substring(0,6)),$("#shortagent").val()?(shortAgentUrl=$("#shortagent").val(),shortAgentUrl_broadcast=$("#shortagent").val()+"_b"):(shortAgentUrl=Math.random().toString(36).slice(2).substring(0,6),shortAgentUrl_broadcast=Math.random().toString(36).slice(2).substring(0,6)),$("#datetime").val()){var t=new Date($("#datetime").val()).toISOString();n.datetime=t}$("#duration").val()&&(n.duration=$("#duration").val()),$("#disableVideo").is(":checked")&&(n.disableVideo=1),$("#disableAudio").is(":checked")&&(n.disableAudio=1),$("#disableScreenShare").is(":checked")&&(n.disableScreenShare=1),$("#disableWhiteboard").is(":checked")&&(n.disableWhiteboard=1),$("#disableTransfer").is(":checked")&&(n.disableTransfer=1),$("#autoAcceptVideo").is(":checked")&&(n.autoAcceptVideo=1),$("#autoAcceptAudio").is(":checked")&&(n.autoAcceptAudio=1);var o="";e&&(o="&broadcast=1");var i=window.btoa(JSON.stringify(n));visitorUrl=lsRepUrl+"pages/"+roomLinkPage+"?room="+sessionId+"&p="+i+o,viewerBroadcastLink=lsRepUrl+"pages/"+roomLinkPage+"?room="+sessionId+"&p="+i+o;var s=document.createElement("input");s.setAttribute("value",visitorUrl),document.body.appendChild(s),s.select(),document.execCommand("copy"),document.body.removeChild(s),$("#roomPass").val()&&(n.pass=$("#roomPass").val()),delete n.visitorName,i=window.btoa(JSON.stringify(n)),agentUrl=lsRepUrl+"pages/"+roomLinkPage+"?room="+sessionId+"&p="+i+"&isAdmin=1"+o,agentBroadcastUrl=lsRepUrl+"pages/"+roomLinkPage+"?room="+sessionId+"&p="+i+"&isAdmin=1"+o},getCurrentTime=function(){return convertTimestamp((new Date).getTime(),!0)},guestName=function(e){e.charCodeAt(0),e.charCodeAt(e.length-1);for(var n=0,t=0;t<e.length;t++)n+=e.charCodeAt(t);return"Visitor-"+parseInt(n%100+1)},getCurrentDateFormatted=function(){var e=new Date;return e.getDate()+"_"+(e.getMonth()+1)+"_"+e.getFullYear()+"_"+e.getHours()+e.getMinutes()+e.getSeconds()},getPrettyDate=function(e){var n=new Date,t=String(n.getDate()).padStart(2,"0"),o=String(n.getMonth()+1).padStart(2,"0"),i=n.getFullYear(),s=new Date(1e3*e),r=s.getFullYear(),a=("0"+(s.getMonth()+1)).slice(-2),d=("0"+s.getDate()).slice(-2),c=("0"+s.getHours()).slice(-2),u=("0"+s.getMinutes()).slice(-2);return t==d&&o==a&&i==r?c+":"+u:d+"."+a+"."+r+" "+c+":"+u},convertTimestamp=function(e,n){var t=new Date,o=new Date(e),i=(t.getFullYear()!==o.getFullYear()&&o.getFullYear(),("0"+(o.getMonth()+1)).slice(-2),("0"+o.getDate()).slice(-2),o.getHours()),s=o.getMinutes(),r=i>=12?"pm":"am",a=i%12;return a=a||12,s=s<10?"0"+s:s,time=a+":"+s+" "+r,time},compareDates=function(e,n){var t=new Date(e);t.setHours(0,0,0,0);var o=new Date(n);return o.setHours(0,0,0,0),t.getTime()===o.getTime()},escapeHtmlEntities=function(e){return"undefined"!=typeof jQuery?jQuery("<div/>").text(e).html():e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},showMessage=function(e,n,t,o,i,s){if(n){var r=getPrettyDate((new Date).getTime()/1e3);if(t=""!==t&&null!==t&&"undefined"!==t&&void 0!==t?t:""===e?"":r,"conference"==conferenceStyle){if("Me"===e){e=smartVideoLocale.msgStore.me,className="media media-chat media-chat-reverse"}else""===e?className="media media-meta-day":($("#peer_name_chat").text(e),playIncomingMessage(),"undefined"===e&&(e="Guest"),className="p-10 media-chat",i||(i=lsRepUrl+"img/small-avatar.jpg"),f=i,"avatar "+e);if(o=o||"",prevId&&e==prevId)l=prevMsgP,d=prevBody;else{if((l=$("<div />",{class:className})).attr("data-system-attribue",o),e&&"Me"!==e){var a=$("<h6 />",{});a.appendTo(l),a.html(e)}var d=$("<div />",{class:"media-body"});d.appendTo(l)}var c;(c=$("<p />")).html(n),c.appendTo(d),(c=$("<p />",{class:"meta"})).html('<time datetime="2018">'+t+"</time>"),c.appendTo(d),l.appendTo($("#chat-content")),$("#typing").html(""),prevId=e,prevMsgP=l,prevBody=d,(u=document.getElementById("chat-content")).scrollTop=999999}else{var u,l=document.createElement("li"),m="left",g="",f="";if("Me"===e||"Me~"==e.substring(0,3)){m="right";var p="";if("Me~"==e.substring(0,3))if(e=e.substring(3,300),p=" right-image","img/small-avatar.jpg"!==i&&i)f='<img class="direct-chat-img '+m+'" src="'+i+'" alt="" />';else f=(f=e.match(/\b(\w)/g).join("").toUpperCase())?'<span class="acronym-right">'+f+"</span>":'<img class="direct-chat-img '+m+'" src="img/small-avatar.jpg" alt="" />';e=smartVideoLocale.msgStore.me,className="wd-right-bubble"+p}else if(""===e){var v="";"divider"===o&&(v=" divider"),className="wd-system-bubble"+v}else if(playIncomingMessage(),"undefined"===e&&(e="Guest"),g="wd-chat-name","wd-chat-avatar",className="wd-left-bubble",i||(i="/img/small-avatar.jpg"),f='<img class="direct-chat-img '+m+" "+guestName(e)+'" src="'+i+'" alt="" />',"He~"==e.substring(0,3))if(e=e.substring(3,500),"/img/small-avatar.jpg"!==i&&i)f='<img class="direct-chat-img '+m+" "+guestName(e)+'" src="'+i+'" alt="" />';else{f=e.match(/\b(\w)/g).join("").toUpperCase();var h=svg1+f+svg2;image="data:image/svg+xml;base64,"+btoa(h),f=f?'<img class="direct-chat-img '+m+" "+guestName(e)+'" src="'+image+'" alt="" />':'<img class="direct-chat-img '+m+" "+guestName(e)+'" src="/img/small-avatar.jpg" alt="" />'}o=o||"",l.setAttribute("data-system-attribue",o),l.innerHTML='<div class="'+className+'">'+f+'<span class="'+g+'">'+e+'</span><span class="timestamp">'+t+"</span><div>"+n+"</div>",(u=document.getElementById("newdev_chat_ul1")).appendChild(l),u.scrollTop=999999}}},saveChat=function(e,n,t,o,i,s){var r=queryString.names?queryString.names:svConfigs.agentName,a=(new Date).toISOString();$.ajax({type:"POST",url:lsRepUrl+"/server/script.php",data:{type:"addchat",roomId:roomId||queryString.room,message:e,agent:r,agentId:o,from:n,participants:Object.keys(s).toString(),system:t,avatar:i,datetime:a}}).done(function(e){}).fail(function(){console.log(!1)})},ERROR_TIMER=1e4,toggleError=function(e,n){jQuery("#error_message").show(),jQuery("#error_message_text").html(e),clearTimeout(errorTimer),errorTimer=setTimeout(function(){jQuery("#error_message").hide(),jQuery("#error_message_text").html("")},n||ERROR_TIMER)},toggleNotification=function(e,n){jQuery("#error_message").toggle(n),jQuery("#error_message_text").html(e)},getCookie=function(e){var n=RegExp(e+"=.[^;]*"),t=document.cookie.match(n);return t?t[0].split("=")[1]:null},deleteCookie=function(e){document.cookie=e+"=; expires=Thu, 01 Jan 1970 00:00:01 GMT;;path=/"},setCookie=function(e,n,t){var o=e,i=n,s=new Date,r=s.getTime()+36e5*parseInt(t);s.setTime(r),document.cookie=t?o+"="+i+";expires="+s.toGMTString()+";path=/":o+"="+i+";path=/"},getGuid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()};function playIncomingCall(){if(!document.hasFocus()){(incomingAudio=new Audio).preload="auto",incomingAudio.autoplay=!0,incomingAudio.loop=!0,incomingAudio.src=lsRepUrl+"/media/ringtone.mp3";var e=incomingAudio.play();isIEA||void 0!==e&&e.then(function(){setTimeout(function(){incomingAudio&&incomingAudio.pause()},1e4)}).catch(function(e){console.log(e)})}}function playIncomingMessage(){if(!document.hasFocus()){(incomingMessage=new Audio).preload="auto",incomingMessage.autoplay=!0,incomingMessage.loop=!1,incomingMessage.src=lsRepUrl+"/media/msgtone.mp3";var e=incomingMessage.play();isIEA||void 0!==e&&e.then(function(){setTimeout(function(){incomingMessage&&incomingMessage.pause()},1e3)}).catch(function(e){console.log(e)})}}function playEnterRoom(){if(!document.hasFocus()){(enterRoom=new Audio).preload="auto",enterRoom.autoplay=!0,enterRoom.loop=!1,enterRoom.src=lsRepUrl+"/media/msgtone.mp3",enterRoom.play();var e=enterRoom.play();void 0!==e&&e.then(function(){setTimeout(function(){enterRoom&&enterRoom.pause()},1e3)}).catch(function(e){console.log(e)})}}function stopIncomingCall(){if(isIEA)return incomingAudio&&(incomingAudio.pause(),incomingAudio.src=""),!0;if(incomingAudio){var e=incomingAudio.pause();void 0!==e&&e.then(function(){}).catch(function(e){console.log(e)})}}function bytesToSize(e){if(0===e)return"0 Bytes";var n=parseInt(Math.floor(Math.log(e)/Math.log(1e3)),10);return(e/Math.pow(1e3,n)).toPrecision(3)+" "+["Bytes","KB","MB","GB","TB"][n]}var notifyHandler=function(){var e=this;this.init=function(){e.isNotificationSupported()?"granted"!==Notification.permission&&Notification.requestPermission():console.log("Your browser does not support Notifications. Use Latest Chrome/Safari to save the world.")},jQuery(document).on("EnterPageNotification",function(n){if(!document.hasFocus()){var t=n.name?n.name:"Visitor";e.showNotification(t+" has requested a chat.")}}),jQuery(document).on("IncomingCall",function(n){document.hasFocus()||e.showNotification("Visitor is calling you.")}),this.showNotification=function(n){if(e.isNotificationSupported())if("granted"===Notification.permission){var t=new Notification(n,{icon:lsRepUrl+"/img/logo.png",body:"Click to open the page.",vibrate:[500,110,500,110,500]});t.onclick=function(){try{window.focus()}catch(e){console.log(e)}},setTimeout(t.close.bind(t),1e4)}else"denied"!==Notification.permission&&Notification.requestPermission().then(function(e){"granted"===e&&(t=new Notification("Hi there!"))});else console.log("Your browser does not support Notifications. Use Latest Chrome/Safari to save the world.")},this.requestPermissions=function(){"granted"!==Notification.permission&&Notification.requestPermission()},this.isNotificationSupported=function(){return"Notification"in window}};!function(e){var n,t={msgStore:{},persistMsgStore:function(t){e.localStorage?(localStorage.setItem("msgStore",JSON.stringify(t)),this.msgStore=t):this.msgStore=t;var o=n.Event("LSLocaleUpdated");n(document).trigger(o)},setLanguage:function(e,o){n.ajax({url:o+"locales/"+e+".json",dataType:"json",success:function(e){t.persistMsgStore(e)},error:function(e){n.getJSON(o+"locales/en_US.json",function(e){t.persistMsgStore(e)})}})},initMsgStore:function(e){var n=e.lang;t.setLanguage(n,e.lsRepUrl)},init:function(t,o){n=o;var i="";e.localStorage&&null!==(i=localStorage.getItem("msgStore"))?(this.initMsgStore(t),this.msgStore=JSON.parse(i)):this.initMsgStore(t)}};e.smartVideoLocale=t}(window);"use strict";var RTCMultiConnection=function(e,n){var t;function o(e,n){function t(e){return!e.audio&&!e.video&&!e.screen&&e.data}var o="";o+="?userid="+e.userid,o+="&sessionid="+e.sessionid,o+="&msgEvent="+e.socketMessageEvent,o+="&socketCustomEvent="+e.socketCustomEvent,o+="&autoCloseEntireSession="+!!e.autoCloseEntireSession,!0===e.session.broadcast&&(o+="&oneToMany=true"),o+="&maxParticipantsAllowed="+e.maxParticipantsAllowed,e.enableScalableBroadcast&&(o+="&enableScalableBroadcast=true",o+="&maxRelayLimitPerUser="+(e.maxRelayLimitPerUser||2)),o+="&extra="+JSON.stringify(e.extra||{}),e.socketCustomParameters&&(o+=e.socketCustomParameters);try{io.sockets={}}catch(e){}if(e.socketURL||(e.socketURL="/"),"/"!=e.socketURL.substr(e.socketURL.length-1,1))throw'"socketURL" MUST end with a slash.';e.enableLogs&&("/"==e.socketURL?console.info("socket.io url is: ",location.origin+"/"):console.info("socket.io url is: ",e.socketURL));try{e.socket=io(e.socketURL+o)}catch(n){e.socket=io.connect(e.socketURL+o,e.socketOptions)}var i=e.multiPeersHandler;function s(n,t){e.peersBackup[n]||(e.peersBackup[n]={userid:n,extra:{}}),e.peersBackup[n].extra=t}e.socket.on("extra-data-updated",function(n,t){e.peers[n]&&(e.peers[n].extra=t,e.onExtraDataUpdated({userid:n,extra:t}),s(n,t))}),e.socket.on(e.socketMessageEvent,function n(o){if(o.remoteUserId==e.userid)if(e.peers[o.sender]&&e.peers[o.sender].extra!=o.message.extra&&(e.peers[o.sender].extra=o.extra,e.onExtraDataUpdated({userid:o.sender,extra:o.extra}),s(o.sender,o.extra)),o.message.streamSyncNeeded&&e.peers[o.sender]){var r=e.streamEvents[o.message.streamid];if(!r||!r.stream)return;var a=o.message.action;if("ended"===a||"inactive"===a||"stream-removed"===a)return e.peersBackup[r.userid]&&(r.extra=e.peersBackup[r.userid].extra),void e.onstreamended(r);var d="both"!=o.message.type?o.message.type:null;"function"==typeof r.stream[a]&&r.stream[a](d)}else if("dropPeerConnection"!==o.message){if(o.message.allParticipants)return-1===o.message.allParticipants.indexOf(o.sender)&&o.message.allParticipants.push(o.sender),void o.message.allParticipants.forEach(function(n){i[e.peers[n]?"renegotiatePeer":"createNewPeer"](n,{localPeerSdpConstraints:{OfferToReceiveAudio:e.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:e.sdpConstraints.mandatory.OfferToReceiveVideo},remotePeerSdpConstraints:{OfferToReceiveAudio:e.session.oneway?!!e.session.audio:e.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:e.session.oneway?!!e.session.video||!!e.session.screen:e.sdpConstraints.mandatory.OfferToReceiveVideo},isOneWay:!!e.session.oneway||"one-way"===e.direction,isDataOnly:t(e.session)})});if(o.message.newParticipant){if(o.message.newParticipant==e.userid)return;if(e.peers[o.message.newParticipant])return;i.createNewPeer(o.message.newParticipant,o.message.userPreferences||{localPeerSdpConstraints:{OfferToReceiveAudio:e.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:e.sdpConstraints.mandatory.OfferToReceiveVideo},remotePeerSdpConstraints:{OfferToReceiveAudio:e.session.oneway?!!e.session.audio:e.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:e.session.oneway?!!e.session.video||!!e.session.screen:e.sdpConstraints.mandatory.OfferToReceiveVideo},isOneWay:!!e.session.oneway||"one-way"===e.direction,isDataOnly:t(e.session)})}else if(o.message.readyForOffer&&(e.attachStreams.length&&(e.waitingForLocalMedia=!1),e.waitingForLocalMedia))setTimeout(function(){n(o)},1);else if(o.message.newParticipationRequest&&o.sender!==e.userid){e.peers[o.sender]&&e.deletePeer(o.sender);var c={extra:o.extra||{},localPeerSdpConstraints:o.message.remotePeerSdpConstraints||{OfferToReceiveAudio:e.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:e.sdpConstraints.mandatory.OfferToReceiveVideo},remotePeerSdpConstraints:o.message.localPeerSdpConstraints||{OfferToReceiveAudio:e.session.oneway?!!e.session.audio:e.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:e.session.oneway?!!e.session.video||!!e.session.screen:e.sdpConstraints.mandatory.OfferToReceiveVideo},isOneWay:void 0!==o.message.isOneWay?o.message.isOneWay:!!e.session.oneway||"one-way"===e.direction,isDataOnly:void 0!==o.message.isDataOnly?o.message.isDataOnly:t(e.session),dontGetRemoteStream:void 0!==o.message.isOneWay?o.message.isOneWay:!!e.session.oneway||"one-way"===e.direction,dontAttachLocalStream:!!o.message.dontGetRemoteStream,connectionDescription:o,successCallback:function(){}};e.onNewParticipant(o.sender,c)}else{if(o.message.changedUUID&&e.peers[o.message.oldUUID]&&(e.peers[o.message.newUUID]=e.peers[o.message.oldUUID],delete e.peers[o.message.oldUUID]),o.message.userLeft)return i.onUserLeft(o.sender),void(o.message.autoCloseEntireSession&&e.leave());i.addNegotiatedMessage(o.message,o.sender)}}else e.deletePeer(o.sender)});var r=!1;e.socket.resetProps=function(){r=!1},e.socket.on("connect",function(){r||(r=!0,e.enableLogs&&console.info("socket.io connection is opened."),setTimeout(function(){e.socket.emit("extra-data-updated",e.extra)},1e3),n&&n(e.socket))}),e.socket.on("disconnect",function(n){e.onSocketDisconnect(n)}),e.socket.on("error",function(n){e.onSocketError(n)}),e.socket.on("user-disconnected",function(n){n!==e.userid&&(e.onUserStatusChanged({userid:n,status:"offline",extra:e.peers[n]&&e.peers[n].extra||{}}),e.deletePeer(n))}),e.socket.on("user-connected",function(n){n!==e.userid&&e.onUserStatusChanged({userid:n,status:"online",extra:e.peers[n]&&e.peers[n].extra||{}})}),e.socket.on("closed-entire-session",function(n,t){e.leave(),e.onEntireSessionClosed({sessionid:n,userid:n,extra:t})}),e.socket.on("userid-already-taken",function(n,t){e.onUserIdAlreadyTaken(n,t)}),e.socket.on("logs",function(n){e.enableLogs&&console.debug("server-logs",n)}),e.socket.on("number-of-broadcast-viewers-updated",function(n){e.onNumberOfBroadcastViewersUpdated(n)}),e.socket.on("set-isInitiator-true",function(n){n==e.sessionid&&(e.isInitiator=!0)})}function i(e){var n=this,t=["getAllParticipants","getLength","selectFirst","streams","send","forEach"];function o(){e.fbr=new FileBufferReader,e.fbr.onProgress=function(n){e.onFileProgress(n)},e.fbr.onBegin=function(n){e.onFileStart(n)},e.fbr.onEnd=function(n){e.onFileEnd(n)}}e.peers={getLength:function(){var e=0;for(var n in this)-1==t.indexOf(n)&&e++;return e},selectFirst:function(){var e;for(var n in this)-1==t.indexOf(n)&&(e=this[n]);return e},getAllParticipants:function(e){var n=[];for(var o in this)-1==t.indexOf(o)&&o!=e&&n.push(o);return n},forEach:function(n){this.getAllParticipants().forEach(function(t){n(e.peers[t])})},send:function(t,o){var i=this;if(!m(t.size)&&!m(t.type)){if(e.enableFileSharing)return void n.shareFile(t,o);"string"!=typeof t&&(t=JSON.stringify(t))}if("text"===t.type||t instanceof ArrayBuffer||t instanceof DataView){if("text"===t.type&&(t=JSON.stringify(t)),o){var s=e.peers[o];if(s)return s.channels.length?void s.channels.forEach(function(e){e.send(t)}):(e.peers[o].createDataChannel(),e.renegotiate(o),void setTimeout(function(){i.send(t,o)},3e3))}this.getAllParticipants().forEach(function(n){if(!i[n].channels.length)return e.peers[n].createDataChannel(),e.renegotiate(n),void setTimeout(function(){i[n].channels.forEach(function(e){e.send(t)})},3e3);i[n].channels.forEach(function(e){e.send(t)})})}else P.send({text:t,channel:this,connection:e,remoteUserId:o})}},this.uuid=e.userid,this.getLocalConfig=function(t,i,s){return s||(s={}),{streamsToShare:s.streamsToShare||{},rtcMultiConnection:e,connectionDescription:s.connectionDescription,userid:i,localPeerSdpConstraints:s.localPeerSdpConstraints,remotePeerSdpConstraints:s.remotePeerSdpConstraints,dontGetRemoteStream:!!s.dontGetRemoteStream,dontAttachLocalStream:!!s.dontAttachLocalStream,renegotiatingPeer:!!s.renegotiatingPeer,peerRef:s.peerRef,channels:s.channels||[],onLocalSdp:function(e){n.onNegotiationNeeded(e,i)},onLocalCandidate:function(t){(t=T.processCandidates(e,t))&&n.onNegotiationNeeded(t,i)},remoteSdp:t,onDataChannelMessage:function(t){if(!e.fbr&&e.enableFileSharing&&o(),"string"!=typeof t&&e.enableFileSharing){var s=this;t instanceof ArrayBuffer||t instanceof DataView?e.fbr.convertToObject(t,function(e){s.onDataChannelMessage(e)}):t.readyForNextChunk?e.fbr.getNextChunk(t,function(n,t){e.peers[i].channels.forEach(function(e){e.send(n)})},i):t.chunkMissing?e.fbr.chunkMissing(t):e.fbr.addChunk(t,function(n){e.peers[i].peer.channel.send(n)})}else n.onDataChannelMessage(t,i)},onDataChannelError:function(e){n.onDataChannelError(e,i)},onDataChannelOpened:function(e){n.onDataChannelOpened(e,i)},onDataChannelClosed:function(e){n.onDataChannelClosed(e,i)},onRemoteStream:function(t){e.peers[i]&&e.peers[i].streams.push(t),n.onGettingRemoteMedia(t,i)},onRemoteStreamRemoved:function(e){n.onRemovingRemoteMedia(e,i)},onPeerStateChanged:function(e){n.onPeerStateChanged(e),"new"===e.iceConnectionState&&n.onNegotiationStarted(i,e),"connected"===e.iceConnectionState&&n.onNegotiationCompleted(i,e),-1!==e.iceConnectionState.search(/closed|failed/gi)&&(n.onUserLeft(i),n.disconnectWith(i))}}},this.createNewPeer=function(n,t){if(!(e.maxParticipantsAllowed<=e.getAllParticipants().length)){if(t=t||{},e.isInitiator&&e.session.audio&&"two-way"===e.session.audio&&!t.streamsToShare&&(t.isOneWay=!1,t.isDataOnly=!1,t.session=e.session),!t.isOneWay&&!t.isDataOnly)return t.isOneWay=!0,void this.onNegotiationNeeded({enableMedia:!0,userPreferences:t},n);t=e.setUserPreferences(t,n);var o=this.getLocalConfig(null,n,t);e.peers[n]=new E(o)}},this.createAnsweringPeer=function(n,t,o){o=e.setUserPreferences(o||{},t);var i=this.getLocalConfig(n,t,o);e.peers[t]=new E(i)},this.renegotiatePeer=function(n,t,o){if(e.peers[n]){t||(t={}),t.renegotiatingPeer=!0,t.peerRef=e.peers[n].peer,t.channels=e.peers[n].channels;var i=this.getLocalConfig(o,n,t);e.peers[n]=new E(i)}else e.enableLogs&&console.error("Peer ("+n+") does not exist. Renegotiation skipped.")},this.replaceTrack=function(n,t,o){if(!e.peers[t])throw"This peer ("+t+") does not exist.";var i=e.peers[t].peer;i.getSenders&&"function"==typeof i.getSenders&&i.getSenders().length?i.getSenders().forEach(function(i){o&&"video"===i.track.kind&&(e.peers[t].peer.lastVideoTrack=i.track,i.replaceTrack(n)),o||"audio"!==i.track.kind||(e.peers[t].peer.lastAudioTrack=i.track,i.replaceTrack(n))}):(console.warn("RTPSender.replaceTrack is NOT supported."),this.renegotiatePeer(t))},this.onNegotiationNeeded=function(e,n){},this.addNegotiatedMessage=function(t,o){if(t.type&&t.sdp)return"answer"==t.type&&e.peers[o]&&e.peers[o].addRemoteSdp(t),"offer"==t.type&&(t.renegotiatingPeer?this.renegotiatePeer(o,null,t):this.createAnsweringPeer(t,o)),void(e.enableLogs&&console.log("Remote peer's sdp:",t.sdp));if(t.candidate)return e.peers[o]&&e.peers[o].addRemoteCandidate(t),void(e.enableLogs&&console.log("Remote peer's candidate pairs:",t.candidate));if(t.enableMedia){e.session=t.userPreferences.session||e.session,e.session.oneway&&e.attachStreams.length&&(e.attachStreams=[]),t.userPreferences.isDataOnly&&e.attachStreams.length&&(e.attachStreams.length=[]);var i={};e.attachStreams.forEach(function(e){i[e.streamid]={isAudio:!!e.isAudio,isVideo:!!e.isVideo,isScreen:!!e.isScreen}}),t.userPreferences.streamsToShare=i,n.onNegotiationNeeded({readyForOffer:!0,userPreferences:t.userPreferences},o)}t.readyForOffer&&e.onReadyForOffer(o,t.userPreferences)},this.onGettingRemoteMedia=function(e,n){},this.onRemovingRemoteMedia=function(e,n){},this.onGettingLocalMedia=function(e){},this.onLocalMediaError=function(n,t){e.onMediaError(n,t)},this.shareFile=function(n,t){o(),e.fbr.readAsArrayBuffer(n,function(n){var o=e.getAllParticipants();t&&(o=[t]),o.forEach(function(t){e.fbr.getNextChunk(n,function(n){e.peers[t].channels.forEach(function(e){e.send(n)})},t)})},{userid:e.userid,chunkSize:"Firefox"===DetectRTC.browser.name?15e3:e.chunkSize||0})};var i=new M(e);this.onDataChannelMessage=function(n,t){i.receive(JSON.parse(n),t,e.peers[t]?e.peers[t].extra:{})},this.onDataChannelClosed=function(n,t){n.userid=t,n.extra=e.peers[t]?e.peers[t].extra:{},e.onclose(n)},this.onDataChannelError=function(n,t){n.userid=t,event.extra=e.peers[t]?e.peers[t].extra:{},e.onerror(n)},this.onDataChannelOpened=function(n,t){e.peers[t].channels.length?e.peers[t].channels=[n]:(e.peers[t].channels.push(n),e.onopen({userid:t,extra:e.peers[t]?e.peers[t].extra:{},channel:n}))},this.onPeerStateChanged=function(n){e.onPeerStateChanged(n)},this.onNegotiationStarted=function(e,n){},this.onNegotiationCompleted=function(e,n){},this.getRemoteStreams=function(n){return n=n||e.peers.getAllParticipants()[0],e.peers[n]?e.peers[n].streams:[]}}function s(e,n,t){if("undefined"!=typeof CustomEvent){var o=new CustomEvent(n,{arguments:t,__exposedProps__:t});e.dispatchEvent(o)}}function r(e,n){n.stream&&n.stream&&n.stream.addEventListener&&(n.stream.addEventListener("mute",function(t){(t=e.streamEvents[n.streamid]).session={audio:"audio"===t.muteType,video:"video"===t.muteType},e.onmute(t)},!1),n.stream.addEventListener("unmute",function(t){(t=e.streamEvents[n.streamid]).session={audio:"audio"===t.unmuteType,video:"video"===t.unmuteType},e.onunmute(t)},!1))}function a(){if(window.crypto&&window.crypto.getRandomValues&&-1===navigator.userAgent.indexOf("Safari")){for(var e=window.crypto.getRandomValues(new Uint32Array(3)),n="",t=0,o=e.length;t<o;t++)n+=e[t].toString(36);return n}return(Math.random()*(new Date).getTime()).toString(36).replace(/\./g,"")}function d(e,n,t){if(t.autoCreateMediaElement){var o=!1;p(e,"video").length||e.isVideo||e.isScreen||(o=!0),"Firefox"===DetectRTC.browser.name&&(t.session.video||t.session.screen)&&(o=!1);var i=document.createElement(o?"audio":"video");if(i.srcObject=e,i.setAttribute("autoplay",!0),i.setAttribute("playsinline",!0),i.setAttribute("controls",!0),i.setAttribute("muted",!1),i.setAttribute("volume",1),"Firefox"===DetectRTC.browser.name){var s="ended";"oninactive"in i&&(s="inactive"),i.addEventListener(s,function(){if(currentUserMediaRequest.remove(e.idInstance),"local"===e.type){s="ended","oninactive"in e&&(s="inactive"),A.onSyncNeeded(e.streamid,s),t.attachStreams.forEach(function(n,o){e.streamid===n.streamid&&delete t.attachStreams[o]});var n=[];t.attachStreams.forEach(function(e){e&&n.push(e)}),t.attachStreams=n;var o=t.streamEvents[e.streamid];if(o)return void t.onstreamended(o);this.parentNode&&this.parentNode.removeChild(this)}},!1)}var r=i.play();if(void 0!==r){var a=!1;setTimeout(function(){a||(a=!0,n(i))},1e3),r.then(function(){a||(a=!0,n(i))}).catch(function(e){a||(a=!0,n(i))})}else n(i)}else n({})}function c(e,n){window.removeEventListener(e,n),window.addEventListener(e,n,!1)}function u(e){var n=[];return e.forEach(function(e){e&&n.push(e)}),n}function l(e){return!e.audio&&!e.video&&!e.screen&&e.data}function m(e){return void 0===e}(t="undefined"!=typeof global?global:null)&&"undefined"==typeof window&&"undefined"!=typeof global&&(global.navigator={userAgent:"Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45",getUserMedia:function(){}},global.console||(global.console={}),void 0===global.console.debug&&(global.console.debug=global.console.info=global.console.error=global.console.log=global.console.log||function(){console.log(arguments)}),"undefined"==typeof document&&(t.document={},document.createElement=document.captureStream=document.mozCaptureStream=function(){var e={getContext:function(){return e},play:function(){},pause:function(){},drawImage:function(){},toDataURL:function(){return""}};return e},document.addEventListener=document.removeEventListener=t.addEventListener=t.removeEventListener=function(){},t.HTMLVideoElement=t.HTMLMediaElement=function(){}),"undefined"==typeof io&&(t.io=function(){return{on:function(e,n){n=n||function(){},"connect"===e&&n()},emit:function(e,n,t){t=t||function(){},"open-room"!==e&&"join-room"!==e||t(!0,n.sessionid,null)}}}),"undefined"==typeof location&&(t.location={protocol:"file:",href:"",hash:"",origin:"self"}),"undefined"==typeof screen&&(t.screen={width:0,height:0}),"undefined"==typeof URL&&(t.URL={createObjectURL:function(){return""},revokeObjectURL:function(){return""}}),t.window=global),function(){var e="Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45";if(h="object"==typeof process&&"object"==typeof process.versions&&process.versions.node&&!process.browser){var n=process.versions.node.toString().replace("v","");e="Nodejs/"+n+" (NodeOS) AppleWebKit/"+n+" (KHTML, like Gecko) Nodejs/"+n+" Nodejs/"+n}!function(n){"undefined"==typeof window&&("undefined"==typeof window&&"undefined"!=typeof global&&(global.navigator={userAgent:e,getUserMedia:function(){}},n.window=global),"undefined"==typeof location&&(n.location={protocol:"file:",href:"",hash:""}),"undefined"==typeof screen&&(n.screen={width:0,height:0}))}("undefined"!=typeof global?global:window);var t=window.navigator;void 0!==t?(void 0!==t.webkitGetUserMedia&&(t.getUserMedia=t.webkitGetUserMedia),void 0!==t.mozGetUserMedia&&(t.getUserMedia=t.mozGetUserMedia)):t={getUserMedia:function(){},userAgent:e};var o=!!/Android|webOS|iPhone|iPad|iPod|BB10|BlackBerry|IEMobile|Opera Mini|Mobile|mobile/i.test(t.userAgent||""),i=!(-1===t.userAgent.indexOf("Edge")||!t.msSaveOrOpenBlob&&!t.msSaveBlob),s=!!window.opera||t.userAgent.indexOf(" OPR/")>=0,r=void 0!==window.InstallTrigger,a=/^((?!chrome|android).)*safari/i.test(t.userAgent),d=!!window.chrome&&!s,c="undefined"!=typeof document&&!!document.documentMode&&!i;function u(e,n){var t=0,o=!1,i=window.setInterval(function(){e()&&(window.clearInterval(i),n(o)),t++>50&&(window.clearInterval(i),n(o=!0))},10)}var l={Android:function(){return t.userAgent.match(/Android/i)},BlackBerry:function(){return t.userAgent.match(/BlackBerry|BB10/i)},iOS:function(){return t.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return t.userAgent.match(/Opera Mini/i)},Windows:function(){return t.userAgent.match(/IEMobile/i)},any:function(){return l.Android()||l.BlackBerry()||l.iOS()||l.Opera()||l.Windows()},getOsName:function(){var e="Unknown OS";return l.Android()&&(e="Android"),l.BlackBerry()&&(e="BlackBerry"),l.iOS()&&(e="iOS"),l.Opera()&&(e="Opera Mini"),l.Windows()&&(e="Windows"),e}};var m="Unknown OS",g="Unknown OS Version";var f,p,v=function(){for(var e,n=t.appVersion,o=t.userAgent,i="-",s=[{s:"Windows 10",r:/(Windows 10.0|Windows NT 10.0)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows Server 2003",r:/Windows NT 5.2/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows ME",r:/(Win 9x 4.90|Windows ME)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 3.11",r:/Win16/},{s:"Android",r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",r:/OS\/2/},{s:"Search Bot",r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}],r=0;e=s[r];r++)if(e.r.test(o)){i=e.s;break}var a="-";switch(/Windows/.test(i)&&(/Windows (.*)/.test(i)&&(a=/Windows (.*)/.exec(i)[1]),i="Windows"),i){case"Mac OS X":/Mac OS X (10[\.\_\d]+)/.test(o)&&(a=/Mac OS X (10[\.\_\d]+)/.exec(o)[1]);break;case"Android":/Android ([\.\_\d]+)/.test(o)&&(a=/Android ([\.\_\d]+)/.exec(o)[1]);break;case"iOS":/OS (\d+)_(\d+)_?(\d+)?/.test(o)&&(a=(a=/OS (\d+)_(\d+)_?(\d+)?/.exec(n))[1]+"."+a[2]+"."+(0|a[3]))}return{osName:i,osVersion:a}}();v&&v.osName&&"-"!=v.osName?(m=v.osName,g=v.osVersion):l.any()&&"Android"==(m=l.getOsName())&&(g=!!(p=(f=(f||t.userAgent).toLowerCase()).match(/android\s([0-9\.]*)/))&&p[1]);var h="object"==typeof process&&"object"==typeof process.versions&&process.versions.node;"Unknown OS"===m&&h&&(m="Nodejs",g=process.versions.node.toString().replace("v",""));var C=!1,S=!1;["captureStream","mozCaptureStream","webkitCaptureStream"].forEach(function(e){"undefined"!=typeof document&&"function"==typeof document.createElement&&(!C&&e in document.createElement("canvas")&&(C=!0),!S&&e in document.createElement("video")&&(S=!0))});var w=/^(192\.168\.|169\.254\.|10\.|172\.(1[6-9]|2\d|3[01]))/,b=/([0-9]{1,3}(\.[0-9]{1,3}){3})/,y=/[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7}/;var E=[],k=[],T=[],R=[];t.mediaDevices&&t.mediaDevices.enumerateDevices&&(t.enumerateDevices=function(e){var n=t.mediaDevices.enumerateDevices();n&&n.then?t.mediaDevices.enumerateDevices().then(e).catch(function(){e([])}):e([])});var x=!1;void 0!==I&&"getSources"in I?x=!0:t.mediaDevices&&t.mediaDevices.enumerateDevices&&(x=!0);var A=!1,M=!1,P=!1,O=!1,D=!1;function U(e){if(x)if(!t.enumerateDevices&&window.MediaStreamTrack&&window.MediaStreamTrack.getSources&&(t.enumerateDevices=window.MediaStreamTrack.getSources.bind(window.MediaStreamTrack)),!t.enumerateDevices&&t.enumerateDevices&&(t.enumerateDevices=t.enumerateDevices.bind(t)),t.enumerateDevices){E=[],k=[],T=[],R=[],A=!1,M=!1,P=!1,O=!1,D=!1;var n={};t.enumerateDevices(function(t){t.forEach(function(e){var t={};for(var o in e)try{"function"!=typeof e[o]&&(t[o]=e[o])}catch(e){}n[t.deviceId+t.label+t.kind]||("audio"===t.kind&&(t.kind="audioinput"),"video"===t.kind&&(t.kind="videoinput"),t.deviceId||(t.deviceId=t.id),t.id||(t.id=t.deviceId),t.label?("videoinput"!==t.kind||D||(D=!0),"audioinput"!==t.kind||O||(O=!0)):(t.isCustomLabel=!0,"videoinput"===t.kind?t.label="Camera "+(R.length+1):"audioinput"===t.kind?t.label="Microphone "+(k.length+1):"audiooutput"===t.kind?t.label="Speaker "+(T.length+1):t.label="Please invoke getUserMedia once.",void 0!==j&&j.browser.isChrome&&j.browser.version>=46&&!/^(https:|chrome-extension:)$/g.test(location.protocol||"")&&"undefined"!=typeof document&&"string"==typeof document.domain&&document.domain.search&&-1===document.domain.search(/localhost|127.0./g)&&(t.label="HTTPs is required to get label of this "+t.kind+" device.")),"audioinput"===t.kind&&(A=!0,-1===k.indexOf(t)&&k.push(t)),"audiooutput"===t.kind&&(M=!0,-1===T.indexOf(t)&&T.push(t)),"videoinput"===t.kind&&(P=!0,-1===R.indexOf(t)&&R.push(t)),E.push(t),n[t.deviceId+t.label+t.kind]=t)}),void 0!==j&&(j.MediaDevices=E,j.hasMicrophone=A,j.hasSpeakers=M,j.hasWebcam=P,j.isWebsiteHasWebcamPermissions=D,j.isWebsiteHasMicrophonePermissions=O,j.audioInputDevices=k,j.audioOutputDevices=T,j.videoInputDevices=R),e&&e()})}else e&&e();else e&&e()}var j=window.DetectRTC||{};j.browser=function(){t.appVersion;var e,n,o,u=t.userAgent,l=t.appName,m=""+parseFloat(t.appVersion),g=parseInt(t.appVersion,10);if(a&&!d&&-1!==u.indexOf("CriOS")&&(a=!1,d=!0),s){l="Opera";try{g=(m=t.userAgent.split("OPR/")[1].split(" ")[0]).split(".")[0]}catch(e){m="0.0.0.0",g=0}}else c?((n=u.indexOf("rv:"))>0?m=u.substring(n+3):(n=u.indexOf("MSIE"),m=u.substring(n+5)),l="IE"):d?(n=u.indexOf("Chrome"),l="Chrome",m=u.substring(n+7)):a?(n=u.indexOf("Safari"),l="Safari",m=u.substring(n+7),-1!==(n=u.indexOf("Version"))&&(m=u.substring(n+8)),-1!==t.userAgent.indexOf("Version/")&&(m=t.userAgent.split("Version/")[1].split(" ")[0])):r?(n=u.indexOf("Firefox"),l="Firefox",m=u.substring(n+8)):(e=u.lastIndexOf(" ")+1)<(n=u.lastIndexOf("/"))&&(l=u.substring(e,n),m=u.substring(n+1),l.toLowerCase()===l.toUpperCase()&&(l=t.appName));return i&&(l="Edge",m=t.userAgent.split("Edge/")[1]),-1!==(o=m.search(/[; \)]/))&&(m=m.substring(0,o)),g=parseInt(""+m,10),isNaN(g)&&(m=""+parseFloat(t.appVersion),g=parseInt(t.appVersion,10)),{fullVersion:m,version:g,name:l,isPrivateBrowsing:!1}}(),function(e){var n;try{if(window.webkitRequestFileSystem)window.webkitRequestFileSystem(window.TEMPORARY,1,function(){n=!1},function(e){n=!0});else if(window.indexedDB&&/Firefox/.test(window.navigator.userAgent)){var t;try{(t=window.indexedDB.open("test")).onerror=function(){return!0}}catch(e){n=!0}void 0===n&&u(function(){return"done"===t.readyState},function(e){e||(n=!t.result)})}else if(function(e){var n=e.toLowerCase();if(0===n.indexOf("msie")&&0===n.indexOf("trident"))return!1;var t=/(?:msie|rv:)\s?([\d\.]+)/.exec(n);return!!(t&&parseInt(t[1],10)>=10)}(window.navigator.userAgent)){n=!1;try{window.indexedDB||(n=!0)}catch(e){n=!0}}else if(window.localStorage&&/Safari/.test(window.navigator.userAgent)){try{window.localStorage.setItem("test",1)}catch(e){n=!0}void 0===n&&(n=!1,window.localStorage.removeItem("test"))}}catch(e){n=!1}u(function(){return void 0!==n},function(t){e(n)})}(function(e){j.browser.isPrivateBrowsing=!!e}),j.browser["is"+j.browser.name]=!0,j.osName=m,j.osVersion=g;"object"==typeof process&&"object"==typeof process.versions&&process.versions["node-webkit"];var L=!1;["RTCPeerConnection","webkitRTCPeerConnection","mozRTCPeerConnection","RTCIceGatherer"].forEach(function(e){L||e in window&&(L=!0)}),j.isWebRTCSupported=L,j.isORTCSupported="undefined"!=typeof RTCIceGatherer;var N=!1;(j.browser.isChrome&&j.browser.version>=35?N=!0:j.browser.isFirefox&&j.browser.version>=34?N=!0:j.browser.isEdge&&j.browser.version>=17?N=!0:"Android"===j.osName&&j.browser.isChrome&&(N=!0),/^(https:|chrome-extension:)$/g.test(location.protocol||""))||("undefined"!=typeof document&&"string"==typeof document.domain&&document.domain.search&&-1===document.domain.search(/localhost|127.0./g)&&(j.browser.isChrome||j.browser.isEdge||j.browser.isOpera)?N=!1:j.browser.isFirefox&&(N=!1));j.isScreenCapturingSupported=N;var V={isSupported:!1,isCreateMediaStreamSourceSupported:!1};["AudioContext","webkitAudioContext","mozAudioContext","msAudioContext"].forEach(function(e){V.isSupported||e in window&&(V.isSupported=!0,window[e]&&"createMediaStreamSource"in window[e].prototype&&(V.isCreateMediaStreamSourceSupported=!0))}),j.isAudioContextSupported=V.isSupported,j.isCreateMediaStreamSourceSupported=V.isCreateMediaStreamSourceSupported;var F=!1;j.browser.isChrome&&j.browser.version>31&&(F=!0),j.isRtpDataChannelsSupported=F;var Q=!1;j.browser.isFirefox&&j.browser.version>28?Q=!0:j.browser.isChrome&&j.browser.version>25?Q=!0:j.browser.isOpera&&j.browser.version>=11&&(Q=!0),j.isSctpDataChannelsSupported=Q,j.isMobileDevice=o;var B=!1;t.getUserMedia?B=!0:t.mediaDevices&&t.mediaDevices.getUserMedia&&(B=!0),j.browser.isChrome&&j.browser.version>=46&&!/^(https:|chrome-extension:)$/g.test(location.protocol||"")&&"undefined"!=typeof document&&"string"==typeof document.domain&&document.domain.search&&-1===document.domain.search(/localhost|127.0./g)&&(B="Requires HTTPs"),"Nodejs"===j.osName&&(B=!1),j.isGetUserMediaSupported=B;var W,q,_,$="";screen.width&&($+=(screen.width?screen.width:"")+" x "+(screen.height?screen.height:""));j.displayResolution=$,j.displayAspectRatio=(W=screen.width,q=screen.height,_=function e(n,t){return 0==t?n:e(t,n%t)}(W,q),W/_/(q/_)).toFixed(2),j.isCanvasSupportsStreamCapturing=C,j.isVideoSupportsStreamCapturing=S,"Chrome"==j.browser.name&&j.browser.version>=53&&(j.isCanvasSupportsStreamCapturing||(j.isCanvasSupportsStreamCapturing="Requires chrome flag: enable-experimental-web-platform-features"),j.isVideoSupportsStreamCapturing||(j.isVideoSupportsStreamCapturing="Requires chrome flag: enable-experimental-web-platform-features")),j.DetectLocalIPAddress=function(e,n){if(j.isWebRTCSupported){var t=!0,o=!0;!function(e,n){if("undefined"==typeof document||"function"!=typeof document.getElementById)return;var t={},o=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;if(!o){var i=document.getElementById("iframe");if(!i)return;var s=i.contentWindow;o=s.RTCPeerConnection||s.mozRTCPeerConnection||s.webkitRTCPeerConnection}if(!o)return;var r=null;"Chrome"===j.browser&&j.browser.version<58&&(r={optional:[{RtpDataChannels:!0}]});var a=new o({iceServers:[{urls:"stun:stun.l.google.com:19302"}]},r);n&&(a.addStream?a.addStream(n):a.addTrack&&n.getTracks()[0]&&a.addTrack(n.getTracks()[0],n));function d(n){if(n){var o=b.exec(n);if(o){var i=o[1],s=n.match(w);void 0===t[i]&&e(i,s,!0),t[i]=!0}}else e()}if(a.onicecandidate=function(e){e.candidate&&e.candidate.candidate?d(e.candidate.candidate):d()},!n)try{a.createDataChannel("sctp",{})}catch(e){}j.isPromisesSupported?a.createOffer().then(function(e){a.setLocalDescription(e).then(c)}):a.createOffer(function(e){a.setLocalDescription(e,c,function(){})},function(){});function c(){a.localDescription.sdp.split("\n").forEach(function(e){e&&0===e.indexOf("a=candidate:")&&d(e)})}}(function(n){n?n.match(w)?e("Local: "+n,t=!1,o):n.match(y)?e("Public: "+n,t,o=!1):e("Public: "+n,t,o):e()},n)}},j.isWebSocketsSupported="WebSocket"in window&&2===window.WebSocket.CLOSING,j.isWebSocketsBlocked=!j.isWebSocketsSupported,"Nodejs"===j.osName&&(j.isWebSocketsSupported=!0,j.isWebSocketsBlocked=!1),j.checkWebSocketsSupport=function(e){e=e||function(){};try{var n,t=new WebSocket("wss://echo.websocket.org:443/");t.onopen=function(){j.isWebSocketsBlocked=!1,n=(new Date).getTime(),t.send("ping")},t.onmessage=function(){j.WebsocketLatency=(new Date).getTime()-n+"ms",e(),t.close(),t=null},t.onerror=function(){j.isWebSocketsBlocked=!0,e()}}catch(n){j.isWebSocketsBlocked=!0,e()}},j.load=function(e){U(e=e||function(){})},j.MediaDevices=void 0!==E?E:[],j.hasMicrophone=A,j.hasSpeakers=M,j.hasWebcam=P,j.isWebsiteHasWebcamPermissions=D,j.isWebsiteHasMicrophonePermissions=O,j.audioInputDevices=k,j.audioOutputDevices=T,j.videoInputDevices=R;var G=!1;"undefined"!=typeof document&&"function"==typeof document.createElement&&"setSinkId"in document.createElement("video")&&(G=!0),j.isSetSinkIdSupported=G;var H=!1;j.browser.isFirefox&&"undefined"!=typeof mozRTCPeerConnection?"getSenders"in mozRTCPeerConnection.prototype&&(H=!0):j.browser.isChrome&&"undefined"!=typeof webkitRTCPeerConnection&&"getSenders"in webkitRTCPeerConnection.prototype&&(H=!0),j.isRTPSenderReplaceTracksSupported=H;var z=!1;j.browser.isFirefox&&j.browser.version>38&&(z=!0),j.isRemoteStreamProcessingSupported=z;var J=!1;void 0!==I&&"applyConstraints"in I.prototype&&(J=!0),j.isApplyConstraintsSupported=J;var Y=!1;j.browser.isFirefox&&j.browser.version>=43&&(Y=!0),j.isMultiMonitorScreenCapturingSupported=Y,j.isPromisesSupported=!!("Promise"in window),j.version="1.3.9",void 0===j&&(window.DetectRTC={});var X=window.MediaStream;void 0===X&&"undefined"!=typeof webkitMediaStream&&(X=webkitMediaStream),j.MediaStream=void 0!==X&&"function"==typeof X&&Object.keys(X.prototype),j.MediaStreamTrack=void 0!==I&&Object.keys(I.prototype);var K=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;j.RTCPeerConnection=void 0!==K&&Object.keys(K.prototype),window.DetectRTC=j,"undefined"!=typeof module&&(module.exports=j),"function"==typeof define&&define.amd&&define("DetectRTC",[],function(){return j})}(),"undefined"!=typeof cordova&&(DetectRTC.isMobileDevice=!0,DetectRTC.browser.name="Chrome"),navigator&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Crosswalk")&&(DetectRTC.isMobileDevice=!0,DetectRTC.browser.name="Chrome"),window.addEventListener||(window.addEventListener=function(e,n,t){e.attachEvent&&e.attachEvent("on"+n,t)}),window.attachEventListener=function(e,n,t,o){e.addEventListener(n,t,o)};var g=window.MediaStream;function f(e,n){return(!e.session.audio||"two-way"!==e.session.audio)&&("Firefox"===DetectRTC.browser.name&&!1!==n||!("Chrome"!==DetectRTC.browser.name||DetectRTC.browser.version<50)&&(!0===typeof n||!(void 0!==n||!e.session.audio||!e.session.screen||e.session.video)&&(n=!0,!0)))}function p(e,n){return e&&e.getTracks?e.getTracks().filter(function(e){return e.kind===(n||"audio")}):[]}function v(){var e=!1;try{if("undefined"==typeof RTCRtpTransceiver)return!1;if(!("currentDirection"in RTCRtpTransceiver.prototype))return!1;var n=new C;try{n.addTransceiver("audio"),e=!0}catch(e){}n.close()}catch(n){e=!1}return e&&function(){var e=!1;try{var n=new C({sdpSemantics:"unified-plan"});try{var t=n.getConfiguration();e="unified-plan"==t.sdpSemantics||(t.sdpSemantics,!1)}catch(n){e=!1}}catch(n){e=!1}return e}()}function h(){if("undefined"!=typeof cordova&&void 0!==cordova.plugins&&void 0!==cordova.plugins.iosrtc){var e=cordova.plugins.iosrtc;window.webkitRTCPeerConnection=e.RTCPeerConnection,window.RTCSessionDescription=e.RTCSessionDescription,window.RTCIceCandidate=e.RTCIceCandidate,window.MediaStream=e.MediaStream,window.MediaStreamTrack=e.MediaStreamTrack,navigator.getUserMedia=navigator.webkitGetUserMedia=e.getUserMedia,e.debug.enable("iosrtc*"),"function"==typeof e.selectAudioOutput&&e.selectAudioOutput(window.iOSDefaultAudioOutputDevice||"speaker"),e.registerGlobals()}}void 0===g&&"undefined"!=typeof webkitMediaStream&&(g=webkitMediaStream),void 0!==g&&("stop"in g.prototype||(g.prototype.stop=function(){this.getTracks().forEach(function(e){e.stop()})})),window.iOSDefaultAudioOutputDevice=window.iOSDefaultAudioOutputDevice||"speaker",document.addEventListener("deviceready",h,!1),h();var C,S={};function w(e){return{OfferToReceiveAudio:!!e.OfferToReceiveAudio,OfferToReceiveVideo:!!e.OfferToReceiveVideo}}void 0!==window.RTCPeerConnection?C=window.RTCPeerConnection:"undefined"!=typeof mozRTCPeerConnection?C=mozRTCPeerConnection:"undefined"!=typeof webkitRTCPeerConnection&&(C=webkitRTCPeerConnection);var b=window.RTCSessionDescription||window.mozRTCSessionDescription,y=window.RTCIceCandidate||window.mozRTCIceCandidate,I=window.MediaStreamTrack;function E(e){if(void 0!==window.RTCPeerConnection?C=window.RTCPeerConnection:"undefined"!=typeof mozRTCPeerConnection?C=mozRTCPeerConnection:"undefined"!=typeof webkitRTCPeerConnection&&(C=webkitRTCPeerConnection),b=window.RTCSessionDescription||window.mozRTCSessionDescription,y=window.RTCIceCandidate||window.mozRTCIceCandidate,I=window.MediaStreamTrack,!C)throw"WebRTC 1.0 (RTCPeerConnection) API are NOT available in this browser.";var n=e.rtcMultiConnection;this.extra=e.remoteSdp?e.remoteSdp.extra:n.extra,this.userid=e.userid,this.streams=[],this.channels=e.channels||[],this.connectionDescription=e.connectionDescription,this.addStream=function(e){n.addStream(e,t.userid)},this.removeStream=function(e){n.removeStream(e,t.userid)};var t=this;e.remoteSdp&&(this.connectionDescription=e.remoteSdp.connectionDescription);var o,i={};S.sdpConstraints=w({OfferToReceiveAudio:!0,OfferToReceiveVideo:!0});var s=!!e.renegotiatingPeer;e.remoteSdp&&(s=!!e.remoteSdp.renegotiatingPeer);var r=[];if(n.attachStreams.forEach(function(e){e&&r.push(e)}),s)o=e.peerRef;else{var a="all";(n.candidates.turn||n.candidates.relay)&&(n.candidates.stun||n.candidates.reflexive||n.candidates.host||(a="relay"));try{var d={iceServers:n.iceServers,iceTransportPolicy:n.iceTransportPolicy||a};void 0!==n.iceCandidatePoolSize&&(d.iceCandidatePoolSize=n.iceCandidatePoolSize),void 0!==n.bundlePolicy&&(d.bundlePolicy=n.bundlePolicy),void 0!==n.rtcpMuxPolicy&&(d.rtcpMuxPolicy=n.rtcpMuxPolicy),n.sdpSemantics&&(d.sdpSemantics=n.sdpSemantics||"unified-plan"),n.iceServers&&n.iceServers.length||(d=null,n.optionalArgument=null),o=new C(d,n.optionalArgument)}catch(e){try{d={iceServers:n.iceServers};o=new C(d)}catch(e){o=new C}}}!o.getRemoteStreams&&o.getReceivers&&(o.getRemoteStreams=function(){var e=new g;return o.getReceivers().forEach(function(n){e.addTrack(n.track)}),[e]}),!o.getLocalStreams&&o.getSenders&&(o.getLocalStreams=function(){var e=new g;return o.getSenders().forEach(function(n){e.addTrack(n.track)}),[e]}),o.onicecandidate=function(i){if(i.candidate)n.trickleIce&&e.onLocalCandidate({candidate:i.candidate.candidate,sdpMid:i.candidate.sdpMid,sdpMLineIndex:i.candidate.sdpMLineIndex});else if(!n.trickleIce){var s=o.localDescription;e.onLocalSdp({type:s.type,sdp:s.sdp,remotePeerSdpConstraints:e.remotePeerSdpConstraints||!1,renegotiatingPeer:!!e.renegotiatingPeer||!1,connectionDescription:t.connectionDescription,dontGetRemoteStream:!!e.dontGetRemoteStream,extra:n?n.extra:{},streamsToShare:f})}},r.forEach(function(i){e.remoteSdp&&e.remoteSdp.remotePeerSdpConstraints&&e.remoteSdp.remotePeerSdpConstraints.dontGetRemoteStream||e.dontAttachLocalStream||(i=n.beforeAddingStream(i,t))&&(o.getLocalStreams().forEach(function(e){i&&e.id==i.id&&(i=null)}),i&&i.getTracks&&i.getTracks().forEach(function(e){try{o.addTrack(e,i)}catch(e){}}))}),o.oniceconnectionstatechange=o.onsignalingstatechange=function(){var i=t.extra;n.peers[t.userid]&&(i=n.peers[t.userid].extra||i),o&&(e.onPeerStateChanged({iceConnectionState:o.iceConnectionState,iceGatheringState:o.iceGatheringState,signalingState:o.signalingState,extra:i,userid:t.userid}),o&&o.iceConnectionState&&-1!==o.iceConnectionState.search(/closed|failed/gi)&&t.streams instanceof Array&&t.streams.forEach(function(e){var t=n.streamEvents[e.id]||{streamid:e.id,stream:e,type:"remote"};n.onstreamended(t)}))};var c={OfferToReceiveAudio:!!r.length,OfferToReceiveVideo:!!r.length};e.localPeerSdpConstraints&&(c=e.localPeerSdpConstraints),S.sdpConstraints=w(c);var u={};o.ontrack=function(n){if(n&&"track"===n.type)if(n.stream=n.streams[n.streams.length-1],n.stream.id||(n.stream.id=n.track.id),u[n.stream.id]&&"Safari"!==DetectRTC.browser.name)n.track&&(n.track.onended=function(){o&&o.onremovestream(n)});else{u[n.stream.id]=n.stream.id;var t={};e.remoteSdp&&e.remoteSdp.streamsToShare?t=e.remoteSdp.streamsToShare:e.streamsToShare&&(t=e.streamsToShare);var s=t[n.stream.id];s?(n.stream.isAudio=s.isAudio,n.stream.isVideo=s.isVideo,n.stream.isScreen=s.isScreen):(n.stream.isVideo=!!p(n.stream,"video").length,n.stream.isAudio=!n.stream.isVideo,n.stream.isScreen=!1),n.stream.streamid=n.stream.id,i[n.stream.id]=n.stream,e.onRemoteStream(n.stream),n.stream.getTracks().forEach(function(e){e.onended=function(){o&&o.onremovestream(n)}}),n.stream.onremovetrack=function(){o&&o.onremovestream(n)}}},o.onremovestream=function(n){n.stream.streamid=n.stream.id,i[n.stream.id]&&delete i[n.stream.id],e.onRemoteStreamRemoved(n.stream)},"function"!=typeof o.removeStream&&(o.removeStream=function(e){e.getTracks().forEach(function(n){o.removeTrack(n,e)})}),this.addRemoteCandidate=function(e){o.addIceCandidate(new y(e))},this.addRemoteSdp=function(e,t){t=t||function(){},"Safari"!==DetectRTC.browser.name&&(e.sdp=n.processSdp(e.sdp)),o.setRemoteDescription(new b(e)).then(t,function(o){n.enableLogs&&console.error("setRemoteDescription failed","\n",o,"\n",e.sdp),t()}).catch(function(o){n.enableLogs&&console.error("setRemoteDescription failed","\n",o,"\n",e.sdp),t()})};var l=!0;function m(n){n.binaryType="arraybuffer",n.onmessage=function(n){e.onDataChannelMessage(n.data)},n.onopen=function(){e.onDataChannelOpened(n)},n.onerror=function(n){e.onDataChannelError(n)},n.onclose=function(n){e.onDataChannelClosed(n)},n.internalSend=n.send,n.send=function(e){"open"===n.readyState&&n.internalSend(e)},o.channel=n}e.remoteSdp&&(l=!1),this.createDataChannel=function(){m(o.createDataChannel("sctp",{}))},!0!==n.session.data||s||(l?this.createDataChannel():o.ondatachannel=function(e){m(e.channel)}),this.enableDisableVideoEncoding=function(e){var n;if(o.getSenders().forEach(function(e){n||"video"!==e.track.kind||(n=e)}),n&&n.getParameters){var t=n.getParameters();t.encodings[1]&&(t.encodings[1].active=!!e),t.encodings[2]&&(t.encodings[2].active=!!e),n.setParameters(t)}},e.remoteSdp&&(e.remoteSdp.remotePeerSdpConstraints&&(c=e.remoteSdp.remotePeerSdpConstraints),S.sdpConstraints=w(c),this.addRemoteSdp(e.remoteSdp,function(){v("createAnswer")})),"two-way"!=n.session.audio&&"two-way"!=n.session.video&&"two-way"!=n.session.screen||(S.sdpConstraints=w({OfferToReceiveAudio:"two-way"==n.session.audio||e.remoteSdp&&e.remoteSdp.remotePeerSdpConstraints&&e.remoteSdp.remotePeerSdpConstraints.OfferToReceiveAudio,OfferToReceiveVideo:"two-way"==n.session.video||"two-way"==n.session.screen||e.remoteSdp&&e.remoteSdp.remotePeerSdpConstraints&&e.remoteSdp.remotePeerSdpConstraints.OfferToReceiveAudio}));var f={};function v(i){o[i](S.sdpConstraints).then(function(i){"Safari"!==DetectRTC.browser.name&&(i.sdp=n.processSdp(i.sdp)),o.setLocalDescription(i).then(function(){n.trickleIce&&(e.onLocalSdp({type:i.type,sdp:i.sdp,remotePeerSdpConstraints:e.remotePeerSdpConstraints||!1,renegotiatingPeer:!!e.renegotiatingPeer||!1,connectionDescription:t.connectionDescription,dontGetRemoteStream:!!e.dontGetRemoteStream,extra:n?n.extra:{},streamsToShare:f}),n.onSettingLocalDescription(t))},function(e){n.enableLogs&&console.error("setLocalDescription error",e)})},function(e){n.enableLogs&&console.error("sdp-error",e)})}o.getLocalStreams().forEach(function(e){f[e.streamid]={isAudio:!!e.isAudio,isVideo:!!e.isVideo,isScreen:!!e.isScreen}}),l&&v("createOffer"),o.nativeClose=o.close,o.close=function(){if(o){try{o.nativeClose!==o.close&&o.nativeClose()}catch(e){}o=null,t.peer=null}},this.peer=o}var k=function(){function e(e,o){var i=t(e);return i.videoCodecNumbers?"vp8"===o&&i.vp8LineNumber===i.videoCodecNumbers[0]?e:"vp9"===o&&i.vp9LineNumber===i.videoCodecNumbers[0]?e:"h264"===o&&i.h264LineNumber===i.videoCodecNumbers[0]?e:e=n(e,o,i):e}function n(e,n,t,o){var i="";if("vp8"===n){if(!t.vp8LineNumber)return e;i=t.vp8LineNumber}if("vp9"===n){if(!t.vp9LineNumber)return e;i=t.vp9LineNumber}if("h264"===n){if(!t.h264LineNumber)return e;i=t.h264LineNumber}var s=t.videoCodecNumbersOriginal.split("SAVPF")[0]+"SAVPF ",r=[i];return o&&(r=[]),t.videoCodecNumbers.forEach(function(e){e!==i&&r.push(e)}),s+=r.join(" "),e=e.replace(t.videoCodecNumbersOriginal,s)}function t(e){var n={};return e.split("\n").forEach(function(e){0===e.indexOf("m=video")&&(n.videoCodecNumbers=[],e.split("SAVPF")[1].split(" ").forEach(function(t){(t=t.trim())&&t.length&&(n.videoCodecNumbers.push(t),n.videoCodecNumbersOriginal=e)})),-1===e.indexOf("VP8/90000")||n.vp8LineNumber||(n.vp8LineNumber=e.replace("a=rtpmap:","").split(" ")[0]),-1===e.indexOf("VP9/90000")||n.vp9LineNumber||(n.vp9LineNumber=e.replace("a=rtpmap:","").split(" ")[0]),-1===e.indexOf("H264/90000")||n.h264LineNumber||(n.h264LineNumber=e.replace("a=rtpmap:","").split(" ")[0])}),n}function o(e,n,t){return function(e,n,t,o,i){for(var s=-1!==t?t:e.length,r=n;r<s;++r)if(0===e[r].indexOf(o)&&(!i||-1!==e[r].toLowerCase().indexOf(i.toLowerCase())))return r;return null}(e,0,-1,n,t)}function i(e){var n=new RegExp("a=rtpmap:(\\d+) \\w+\\/\\d+"),t=e.match(n);return t&&2===t.length?t[1]:null}return{removeVPX:function(e){var o=t(e);return e=n(e,"vp9",o,!0),e=n(e,"vp8",o,!0)},disableNACK:function(e){if(!e||"string"!=typeof e)throw"Invalid arguments.";return e=(e=(e=(e=e.replace("a=rtcp-fb:126 nack\r\n","")).replace("a=rtcp-fb:126 nack pli\r\n","a=rtcp-fb:126 pli\r\n")).replace("a=rtcp-fb:97 nack\r\n","")).replace("a=rtcp-fb:97 nack pli\r\n","a=rtcp-fb:97 pli\r\n")},prioritize:function(e,n){if(n&&n.getSenders&&n.getSenders().length){if(!e||"string"!=typeof e)throw"Invalid arguments.";n.getSenders().forEach(function(n){for(var t=n.getParameters(),o=0;o<t.codecs.length;o++)if(t.codecs[o].mimeType==e){t.codecs.unshift(t.codecs.splice(o,1));break}n.setParameters(t)})}},removeNonG722:function(e){return e.replace(/m=audio ([0-9]+) RTP\/SAVPF ([0-9 ]*)/g,"m=audio $1 RTP/SAVPF 9")},setApplicationSpecificBandwidth:function(e,n,t){return function(e,n,t){return n?void 0!==isFirefox&&isFirefox?e:(t&&(n.screen?n.screen<300&&console.warn("It seems that you are using wrong bandwidth value for screen. Screen sharing is expected to fail."):console.warn("It seems that you are not using bandwidth for screen. Screen sharing is expected to fail.")),n.screen&&t&&(e=(e=e.replace(/b=AS([^\r\n]+\r\n)/g,"")).replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+n.screen+"\r\n")),(n.audio||n.video)&&(e=e.replace(/b=AS([^\r\n]+\r\n)/g,"")),n.audio&&(e=e.replace(/a=mid:audio\r\n/g,"a=mid:audio\r\nb=AS:"+n.audio+"\r\n")),n.screen?e=e.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+n.screen+"\r\n"):n.video&&(e=e.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+n.video+"\r\n")),e):e}(e,n,t)},setVideoBitrates:function(e,n){return function(e,n){var t,s=(n=n||{}).min,r=n.max,a=e.split("\r\n"),d=o(a,"a=rtpmap","VP8/90000");if(d&&(t=i(a[d])),!t)return e;var c,u=o(a,"a=rtpmap","rtx/90000");if(u&&(c=i(a[u])),!u)return e;var l=o(a,"a=fmtp:"+c.toString());if(null!==l){var m="\r\n";m+="a=fmtp:"+t+" x-google-min-bitrate="+(s||"228")+"; x-google-max-bitrate="+(r||"228"),a[l]=a[l].concat(m),e=a.join("\r\n")}return e}(e,n)},setOpusAttributes:function(e,n){return function(e,n){n=n||{};var t,s=e.split("\r\n"),r=o(s,"a=rtpmap","opus/48000");if(r&&(t=i(s[r])),!t)return e;var a=o(s,"a=fmtp:"+t.toString());if(null===a)return e;var d="";return d+="; stereo="+(void 0!==n.stereo?n.stereo:"1"),d+="; sprop-stereo="+(void 0!==n["sprop-stereo"]?n["sprop-stereo"]:"1"),void 0!==n.maxaveragebitrate&&(d+="; maxaveragebitrate="+(n.maxaveragebitrate||1048576)),void 0!==n.maxplaybackrate&&(d+="; maxplaybackrate="+(n.maxplaybackrate||1048576)),void 0!==n.cbr&&(d+="; cbr="+(void 0!==n.cbr?n.cbr:"1")),void 0!==n.useinbandfec&&(d+="; useinbandfec="+n.useinbandfec),void 0!==n.usedtx&&(d+="; usedtx="+n.usedtx),void 0!==n.maxptime&&(d+="\r\na=maxptime:"+n.maxptime),s[a]=s[a].concat(d),e=s.join("\r\n")}(e,n)},preferVP9:function(n){return e(n,"vp9")},preferCodec:e,forceStereoAudio:function(e){for(var n=e.split("\r\n"),t=null,o=0;o<n.length;o++)if(-1!==n[o].search("opus/48000")){var i=extractSdp(n[o],/:(\d+) opus\/48000/i);break}for(o=0;o<n.length;o++){if(-1!==n[o].search("a=fmtp"))if(extractSdp(n[o],/a=fmtp:(\d+)/)===i){t=o;break}}return null===t?e:(n[t]=n[t].concat("; stereo=1; sprop-stereo=1"),e=n.join("\r\n"))}}}();window.BandwidthHandler=k;var T={processCandidates:function(e,n){var t=n.candidate,o=e.candidates,i=o.stun,s=o.turn;if(m(o.reflexive)||(i=o.reflexive),m(o.relay)||(s=o.relay),(o.host||!t.match(/typ host/g))&&(s||!t.match(/typ relay/g))&&(i||!t.match(/typ srflx/g))){var r=e.iceProtocols;if((r.udp||!t.match(/ udp /g))&&(r.tcp||!t.match(/ tcp /g)))return e.enableLogs&&console.debug("Your candidate pairs:",t),{candidate:t,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex}}}},R={getIceServers:function(e){return svConfigs.iceServers.iceServers}};function x(e){if(!0!==currentUserMediaRequest.mutex){currentUserMediaRequest.mutex=!0;var n=JSON.stringify(e.localMediaConstraints);if(currentUserMediaRequest.streams[n])s(currentUserMediaRequest.streams[n].stream,!0);else{if(!!/BB10|BlackBerry/i.test(navigator.userAgent||"")||void 0===navigator.mediaDevices||"function"!=typeof navigator.mediaDevices.getUserMedia)return navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,void navigator.getUserMedia(e.localMediaConstraints,function(e){e.streamid=e.streamid||e.id||a(),e.idInstance=n,s(e)},function(n){e.onLocalMediaError(n,e.localMediaConstraints)});if(void 0===navigator.mediaDevices){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;var t,o,i=function(){};navigator.mediaDevices={getUserMedia:function(e){return navigator.getUserMedia(e,function(e){e(stream),t=stream},function(e){i(e),o=e}),{then:function(e){if(!t)return e,{then:function(e){o?e(o):i=e}};e(t)}}}}}if(!0===e.localMediaConstraints.isScreen){if(navigator.mediaDevices.getDisplayMedia)navigator.mediaDevices.getDisplayMedia(e.localMediaConstraints).then(function(e){e.streamid=e.streamid||e.id||a(),e.idInstance=n,s(e)}).catch(function(n){e.onLocalMediaError(n,e.localMediaConstraints)});else{if(!navigator.getDisplayMedia)throw new Error("getDisplayMedia API is not availabe in this browser.");navigator.getDisplayMedia(e.localMediaConstraints).then(function(e){e.streamid=e.streamid||e.id||a(),e.idInstance=n,s(e)}).catch(function(n){e.onLocalMediaError(n,e.localMediaConstraints)})}return}navigator.mediaDevices.getUserMedia(e.localMediaConstraints).then(function(e){e.streamid=e.streamid||e.id||a(),e.idInstance=n,s(e)}).catch(function(n){e.onLocalMediaError(n,e.localMediaConstraints)})}}else currentUserMediaRequest.queueRequests.push(e);function s(t,o){!function(e,n){e.mandatory&&e.mandatory.chromeMediaSource?n.isScreen=!0:e.mozMediaSource||e.mediaSource?n.isScreen=!0:e.video?n.isVideo=!0:e.audio&&(n.isAudio=!0)}(e.localMediaConstraints,t);var i="ended";"oninactive"in t&&(i="inactive"),t.addEventListener(i,function(){delete currentUserMediaRequest.streams[n],currentUserMediaRequest.mutex=!1,currentUserMediaRequest.queueRequests.indexOf(e)&&(delete currentUserMediaRequest.queueRequests[currentUserMediaRequest.queueRequests.indexOf(e)],currentUserMediaRequest.queueRequests=u(currentUserMediaRequest.queueRequests))},!1),currentUserMediaRequest.streams[n]={stream:t},currentUserMediaRequest.mutex=!1,currentUserMediaRequest.queueRequests.length&&x(currentUserMediaRequest.queueRequests.shift()),e.onGettingLocalMedia(t,o)}}window.currentUserMediaRequest={streams:[],mutex:!1,queueRequests:[],remove:function(e){this.mutex=!1;var n=this.streams[e];if(n){var t=(n=n.stream).currentUserMediaRequestOptions;this.queueRequests.indexOf(t)&&(delete this.queueRequests[this.queueRequests.indexOf(t)],this.queueRequests=u(this.queueRequests)),this.streams[e].stream=null,delete this.streams[e]}}};var A=function(){function e(e){if(e)return"string"==typeof e||void 0===e?e:e.audio&&e.video?null:e.audio?"audio":e.video?"video":void 0}return{setHandlers:function(n,t,o){if(n&&n.addEventListener){if(void 0===t||1==t){var i="ended";"oninactive"in n&&(i="inactive"),n.addEventListener(i,function(){A.onSyncNeeded(this.streamid,i)},!1)}n.mute=function(i,r){i=e(i),void 0!==r&&(t=r),void 0!==i&&"audio"!=i||p(n,"audio").forEach(function(e){e.enabled=!1,o.streamEvents[n.streamid].isAudioMuted=!0}),void 0!==i&&"video"!=i||p(n,"video").forEach(function(e){e.enabled=!1}),void 0!==t&&1!=t||A.onSyncNeeded(n.streamid,"mute",i),o.streamEvents[n.streamid].muteType=i||"both",s(n,"mute",i)},n.unmute=function(i,r){i=e(i),void 0!==r&&(t=r),function(){if(!o.streamEvents[n.streamid].mediaElement)return;var e=o.streamEvents[n.streamid].mediaElement;e.volume=0,function e(n,t,o,i){i=(i||0)+1;if(i>=t)return;setTimeout(function(){o(),e(n,t,o,i)},n)}(200,5,function(){try{e.volume+=.2}catch(n){e.volume=1}})}(),void 0!==i&&"audio"!=i||p(n,"audio").forEach(function(e){e.enabled=!0,o.streamEvents[n.streamid].isAudioMuted=!1}),void 0!==i&&"video"!=i||(p(n,"video").forEach(function(e){e.enabled=!0}),void 0!==i&&"video"==i&&o.streamEvents[n.streamid].isAudioMuted&&function e(t){t||(t=0),++t<100&&o.streamEvents[n.streamid].isAudioMuted&&(n.mute("audio"),setTimeout(function(){e(t)},50))}()),void 0!==t&&1!=t||A.onSyncNeeded(n.streamid,"unmute",i),o.streamEvents[n.streamid].unmuteType=i||"both",s(n,"unmute",i)}}},onSyncNeeded:function(e,n,t){}}}();function M(e){var n={};return{receive:function(t,o,i){var s=t.uuid;if(n[s]||(n[s]=[]),n[s].push(t.message),t.last){var r=n[s].join("");t.isobject&&(r=JSON.parse(r));var a={data:r,userid:o,extra:i,latency:(new Date).getTime()-t.sendingTime};e.autoTranslateText?(a.original=a.data,e.Translator.TranslateText(a.data,function(n){a.data=n,e.onmessage(a)})):e.onmessage(a),delete n[s]}}}}var P={send:function(e){var n=e.connection,t=e.channel,o=e.remoteUserId,i=e.text,s=n.chunkSize||1e3,r="",d=!1;"string"!=typeof i&&(d=!0,i=JSON.stringify(i));var c=a(),u=(new Date).getTime();!function e(i,a){var l={type:"text",uuid:c,sendingTime:u};i&&(a=i,l.packets=parseInt(a.length/s));a.length>s?l.message=a.slice(0,s):(l.message=a,l.last=!0,l.isobject=d);t.send(l,o);r=a.slice(l.message.length);r.length&&setTimeout(function(){e(null,r)},n.chunkInterval||100)}(i)}},O={handle:function(e){var n={};e.onFileStart=function(t){var o=document.createElement("div");if(o.title=t.name,o.innerHTML="<label>0%</label> <progress></progress>",t.remoteUserId&&(o.innerHTML+=" (Sharing with:"+t.remoteUserId+")"),e.filesContainer||(e.filesContainer=document.body||document.documentElement),e.filesContainer.insertBefore(o,e.filesContainer.firstChild),!t.remoteUserId)return n[t.uuid]={div:o,progress:o.querySelector("progress"),label:o.querySelector("label")},void(n[t.uuid].progress.max=t.maxChunks);n[t.uuid]||(n[t.uuid]={}),n[t.uuid][t.remoteUserId]={div:o,progress:o.querySelector("progress"),label:o.querySelector("label")},n[t.uuid][t.remoteUserId].progress.max=t.maxChunks},e.onFileProgress=function(e){var t=n[e.uuid];t&&(e.remoteUserId&&!(t=n[e.uuid][e.remoteUserId])||(t.progress.value=e.currentPosition||e.maxChunks||t.progress.max,function(e,n){if(-1!==e.position){var t=+e.position.toFixed(2).split(".")[1]||100;n.innerHTML=t+"%"}}(t.progress,t.label)))},e.onFileEnd=function(e){var t=n[e.uuid];if(t){if(!e.remoteUserId||(t=n[e.uuid][e.remoteUserId])){var o=t.div;-1!=e.type.indexOf("image")?o.innerHTML='<a href="'+e.url+'" download="'+e.name+'">Download <strong style="color:red;">'+e.name+'</strong> </a><br /><img src="'+e.url+'" title="'+e.name+'" style="max-width: 80%;">':o.innerHTML='<a href="'+e.url+'" download="'+e.name+'">Download <strong style="color:red;">'+e.name+'</strong> </a><br /><iframe src="'+e.url+'" title="'+e.name+'" style="width: 80%;border: 0;height: inherit;margin-top:1em;"></iframe>'}}else console.error("No such progress-helper element exist.",e)}}},D={handle:function(e){e.autoTranslateText=!1,e.language="en",e.googKey="AIzaSyCgB5hmFY74WYB-EoWkhr9cAGr6TiTHrEE",e.Translator={TranslateText:function(n,t){var o=document.createElement("script");o.type="text/javascript";var i=encodeURIComponent(n),s="method"+e.token();window[s]=function(e){e.data&&e.data.translations[0]&&t?t(e.data.translations[0].translatedText):e.error&&"Daily Limit Exceeded"===e.error.message?console.error('Text translation failed. Error message: "Daily Limit Exceeded."'):e.error?console.error(e.error.message):console.error(e)};var r="https://www.googleapis.com/language/translate/v2?key="+e.googKey+"&target="+(e.language||"en-US")+"&callback=window."+s+"&q="+i;o.src=r,document.getElementsByTagName("head")[0].appendChild(o)},getListOfLanguages:function(n){var t=new XMLHttpRequest;t.onreadystatechange=function(){if(t.readyState==XMLHttpRequest.DONE){var e=JSON.parse(t.responseText);if(e&&e.data&&e.data.languages)return void n(e.data.languages);if(e.error&&"Daily Limit Exceeded"===e.error.message)return void console.error('Text translation failed. Error message: "Daily Limit Exceeded."');if(e.error)return void console.error(e.error.message);console.error(e)}};var o="https://www.googleapis.com/language/translate/v2/languages?key="+e.googKey+"&target=en";t.open("GET",o,!0),t.send(null)}}}};!function(t){n=n||{useDefaultDevices:!0},t.channel=t.sessionid=(e||location.href.replace(/\/|:|#|\?|\$|\^|%|\.|`|~|!|\+|@|\[|\||]|\|*. /g,"").split("\n").join("").split("\r").join(""))+"";var s=new i(t),u={};function m(e){if(t.socketAutoReConnect=!0,t.socket)e&&e(t.socket);else{if(void 0===o)if("undefined"!=typeof FirebaseConnection)window.SocketConnection=FirebaseConnection;else{if("undefined"==typeof PubNubConnection)throw"SocketConnection.js seems missed.";window.SocketConnection=PubNubConnection}new o(t,function(n){e&&e(t.socket)})}}function h(e,n){t.socket.emit("join-room",{sessionid:t.sessionid,session:t.session,mediaConstraints:t.mediaConstraints,sdpConstraints:t.sdpConstraints,streams:w(),extra:t.extra,password:void 0!==t.password&&"object"!=typeof t.password?t.password:""},function(o,i){if(!0===o){if(t.enableLogs&&console.log("isRoomJoined: ",o," roomid: ",t.sessionid),t.peers[t.sessionid])return;s.onNegotiationNeeded(e)}!1===o&&t.enableLogs&&console.warn("isRoomJoined: ",i," roomid: ",t.sessionid),n(o,t.sessionid,i)})}function S(e){t.enableLogs&&console.log("Sending open-room signal to socket.io"),t.waitingForLocalMedia=!1,t.socket.emit("open-room",{sessionid:t.sessionid,session:t.session,mediaConstraints:t.mediaConstraints,sdpConstraints:t.sdpConstraints,streams:w(),extra:t.extra,identifier:t.publicRoomIdentifier,password:void 0!==t.password&&"object"!=typeof t.password?t.password:""},function(n,o){!0===n&&(t.enableLogs&&console.log("isRoomOpened: ",n," roomid: ",t.sessionid),e(n,t.sessionid)),!1===n&&(t.enableLogs&&console.warn("isRoomOpened: ",o," roomid: ",t.sessionid),e(n,t.sessionid,o))})}function w(){try{return t.streamEvents.selectAll("local").map(function(e){return{streamid:e.streamid,tracks:e.stream.getTracks().length}})}catch(e){return[]}}function b(e,n){if(t.dontCaptureUserMedia||e.isDataOnly)n();else{var o={};e.localPeerSdpConstraints.OfferToReceiveAudio&&(o.audio=t.mediaConstraints.audio),e.localPeerSdpConstraints.OfferToReceiveVideo&&(o.video=t.mediaConstraints.video);var i=e.session||t.session;i.oneway&&"two-way"!==i.audio&&"two-way"!==i.video&&"two-way"!==i.screen?n():(i.oneway&&i.audio&&"two-way"===i.audio&&(i={audio:!0}),(i.audio||i.video||i.screen)&&(i.screen?"Edge"===DetectRTC.browser.name?navigator.getDisplayMedia({video:!0,audio:f(t)}).then(function(e){e.isScreen=!0,s.onGettingLocalMedia(e),!i.audio&&!i.video||f(t)?n(e):t.invokeGetUserMedia(null,n)},function(e){console.error("Unable to capture screen on Edge. HTTPs and version 17+ is required.")}):t.invokeGetUserMedia({audio:f(t),video:!0,isScreen:!0},!i.audio&&!i.video||f(t)?n:t.invokeGetUserMedia(null,n)):(i.audio||i.video)&&t.invokeGetUserMedia(null,n,i)))}}function y(e,n){e?(n.audio&&p(e,"audio").forEach(function(e){e.applyConstraints(n.audio)}),n.video&&p(e,"video").forEach(function(e){e.applyConstraints(n.video)})):t.enableLogs&&console.error("No stream to applyConstraints.")}function E(e,n,o){n?s.replaceTrack(e,n,o):t.peers.getAllParticipants().forEach(function(n){s.replaceTrack(e,n,o)})}s.onGettingLocalMedia=function(e,n){if(n=n||function(){},u[e.streamid])n();else{u[e.streamid]=!0;try{e.type="local"}catch(e){}t.setStreamEndHandler(e),d(e,function(o){o.id=e.streamid,o.muted=!0,o.volume=0,-1===t.attachStreams.indexOf(e)&&t.attachStreams.push(e),void 0!==A&&A.setHandlers(e,!0,t),t.streamEvents[e.streamid]={stream:e,type:"local",mediaElement:o,userid:t.userid,extra:t.extra,streamid:e.streamid,isAudioMuted:!0};try{!function(e,n){if(n.stream&&p(n.stream,"audio").length){if(!e||!n)throw"Both arguments are required.";if(e.onspeaking&&e.onsilence){if("undefined"==typeof hark)throw"hark.js not found.";hark(n.stream,{onspeaking:function(){e.onspeaking(n)},onsilence:function(){e.onsilence(n)},onvolumechange:function(t,o){e.onvolumechange&&e.onvolumechange(merge({volume:t,threshold:o},n))}})}}}(t,t.streamEvents[e.streamid]),r(t,t.streamEvents[e.streamid]),t.onstream(t.streamEvents[e.streamid])}catch(e){}n()},t)}},s.onGettingRemoteMedia=function(e,n){try{e.type="remote"}catch(e){}t.setStreamEndHandler(e,"remote-stream"),d(e,function(o){o.id=e.streamid,void 0!==A&&A.setHandlers(e,!1,t),t.streamEvents[e.streamid]={stream:e,type:"remote",userid:n,extra:t.peers[n]?t.peers[n].extra:{},mediaElement:o,streamid:e.streamid},r(t,t.streamEvents[e.streamid]),t.onstream(t.streamEvents[e.streamid])},t)},s.onRemovingRemoteMedia=function(e,n){var o=t.streamEvents[e.streamid];o||(o={stream:e,type:"remote",userid:n,extra:t.peers[n]?t.peers[n].extra:{},streamid:e.streamid,mediaElement:t.streamEvents[e.streamid]?t.streamEvents[e.streamid].mediaElement:null}),t.peersBackup[o.userid]&&(o.extra=t.peersBackup[o.userid].extra),t.onstreamended(o),delete t.streamEvents[e.streamid]},s.onNegotiationNeeded=function(e,n,o){o=o||function(){};var i={remoteUserId:n=n||e.remoteUserId,message:e=e||"",sender:t.userid};e.remoteUserId&&e.message&&e.sender&&(i=e),m(function(){t.socket.emit(t.socketMessageEvent,i,o)})},s.onUserLeft=function(e){t.deletePeer(e)},s.disconnectWith=function(e,n){t.socket&&t.socket.emit("disconnect-with",e,n||function(){}),t.deletePeer(e)},t.socketOptions={transport:"polling"},t.openOrJoin=function(e,n){n=n||function(){},t.checkPresence(e,function(e,o){if(e){t.sessionid=o;var i,s,r=!!t.session.oneway,a=l(t.session);s={OfferToReceiveAudio:t.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:t.sdpConstraints.mandatory.OfferToReceiveVideo},i={OfferToReceiveAudio:r?!!t.session.audio:t.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:r?!!t.session.video||!!t.session.screen:t.sdpConstraints.mandatory.OfferToReceiveVideo};var d={remoteUserId:t.sessionid,message:{newParticipationRequest:!0,isOneWay:r,isDataOnly:a,localPeerSdpConstraints:i,remotePeerSdpConstraints:s},sender:t.userid};b(d.message,function(){h(d,n)})}else t.waitingForLocalMedia=!0,t.isInitiator=!0,t.sessionid=o||t.sessionid,l(t.session)?S(n):t.captureUserMedia(function(){S(n)})})},t.waitingForLocalMedia=!1,t.open=function(e,n){n=n||function(){},t.waitingForLocalMedia=!0,t.isInitiator=!0,t.sessionid=e||t.sessionid,m(function(){l(t.session)?S(n):t.captureUserMedia(function(){S(n)})})},t.peersBackup={},t.deletePeer=function(e){if(e&&t.peers[e]){var n={userid:e,extra:t.peers[e]?t.peers[e].extra:{}};if(t.peersBackup[n.userid]&&(n.extra=t.peersBackup[n.userid].extra),t.onleave(n),t.peers[e]){t.peers[e].streams.forEach(function(e){e.stop()});var o=t.peers[e].peer;if(o&&"closed"!==o.iceConnectionState)try{o.close()}catch(e){}t.peers[e]&&(t.peers[e].peer=null,delete t.peers[e])}}},t.rejoin=function(e){if(!t.isInitiator&&e&&Object.keys(e).length){var n={};t.peers[e.remoteUserId]&&(n=t.peers[e.remoteUserId].extra,t.deletePeer(e.remoteUserId)),e&&e.remoteUserId&&(t.join(e.remoteUserId),t.onReConnecting({userid:e.remoteUserId,extra:n}))}},t.join=function(e,n){t.sessionid=!!e&&(e.sessionid||e.remoteUserId||e)||t.sessionid,t.sessionid+="";var o=!1,i=!1,s=!1,r=!1;if(e&&e.session||!e||"string"==typeof e){var a=e&&e.session||t.session;s=!!a.oneway,r=l(a),i={OfferToReceiveAudio:t.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:t.sdpConstraints.mandatory.OfferToReceiveVideo},o={OfferToReceiveAudio:s?!!t.session.audio:t.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:s?!!t.session.video||!!t.session.screen:t.sdpConstraints.mandatory.OfferToReceiveVideo}}var d=function(){};"function"==typeof(n=n||{})&&(d=n,n={}),void 0!==n.localPeerSdpConstraints&&(o=n.localPeerSdpConstraints),void 0!==n.remotePeerSdpConstraints&&(i=n.remotePeerSdpConstraints),void 0!==n.isOneWay&&(s=n.isOneWay),void 0!==n.isDataOnly&&(r=n.isDataOnly);var c={remoteUserId:t.sessionid,message:{newParticipationRequest:!0,isOneWay:s,isDataOnly:r,localPeerSdpConstraints:o,remotePeerSdpConstraints:i},sender:t.userid};return b(c.message,function(){m(function(){h(c,d)})}),c},t.publicRoomIdentifier="",t.getUserMedia=t.captureUserMedia=function(e,n){e=e||function(){};var o=n||t.session;t.dontCaptureUserMedia||l(o)?e():(o.audio||o.video||o.screen)&&(o.screen?"Edge"===DetectRTC.browser.name?navigator.getDisplayMedia({video:!0,audio:f(t)}).then(function(i){if(i.isScreen=!0,s.onGettingLocalMedia(i),!o.audio&&!o.video||f(t))e(i);else{var r={};for(var a in o)"screen"!==a&&(r[a]=o[a]);t.invokeGetUserMedia(n,e,r)}},function(e){console.error("Unable to capture screen on Edge. HTTPs and version 17+ is required.")}):t.invokeGetUserMedia({audio:f(t),video:!0,isScreen:!0},function(i){if(!o.audio&&!o.video||f(t))e(i);else{var s={};for(var r in o)"screen"!==r&&(s[r]=o[r]);t.invokeGetUserMedia(n,e,s)}}):(o.audio||o.video)&&t.invokeGetUserMedia(n,e,o))},t.onbeforeunload=function(e,n){t.closeBeforeUnload&&(t.peers.getAllParticipants().forEach(function(e){s.onNegotiationNeeded({userLeft:!0},e),t.peers[e]&&t.peers[e].peer&&t.peers[e].peer.close(),delete t.peers[e]}),n||t.closeSocket(),t.isInitiator=!1)},window.ignoreBeforeUnload?t.closeBeforeUnload=!1:(t.closeBeforeUnload=!0,window.addEventListener("beforeunload",t.onbeforeunload,!1)),t.userid=a(),t.changeUserId=function(e,n){n=n||function(){},t.userid=e||a(),t.socket.emit("changed-uuid",t.userid,n)},t.extra={},t.attachStreams=[],t.session={audio:!0,video:!0},t.enableFileSharing=!1,t.bandwidth={screen:!1,audio:!1,video:!1},t.codecs={audio:"opus",video:"VP9"},t.processSdp=function(e){return v()?e:"Safari"===DetectRTC.browser.name?e:("VP8"===t.codecs.video.toUpperCase()&&(e=k.preferCodec(e,"vp8")),"VP9"===t.codecs.video.toUpperCase()&&(e=k.preferCodec(e,"vp9")),"H264"===t.codecs.video.toUpperCase()&&(e=k.preferCodec(e,"h264")),"G722"===t.codecs.audio&&(e=k.removeNonG722(e)),"Firefox"===DetectRTC.browser.name?e:((t.bandwidth.video||t.bandwidth.screen)&&(e=k.setApplicationSpecificBandwidth(e,t.bandwidth,!!t.session.screen)),t.bandwidth.video&&(e=k.setVideoBitrates(e,{min:8*t.bandwidth.video*1024,max:8*t.bandwidth.video*1024})),t.bandwidth.audio&&(e=k.setOpusAttributes(e,{maxaveragebitrate:8*t.bandwidth.audio*1024,maxplaybackrate:8*t.bandwidth.audio*1024,stereo:1,maxptime:3})),e))},void 0!==k&&(t.BandwidthHandler=t.CodecsHandler=k),t.mediaConstraints={audio:{mandatory:{},optional:t.bandwidth.audio?[{bandwidth:8*t.bandwidth.audio*1024||1048576}]:[]},video:{mandatory:{},optional:t.bandwidth.video?[{bandwidth:8*t.bandwidth.video*1024||1048576},{facingMode:"user"}]:[{facingMode:"user"}]}},"Firefox"===DetectRTC.browser.name&&(t.mediaConstraints={audio:!0,video:!0}),n.useDefaultDevices||DetectRTC.isMobileDevice||DetectRTC.load(function(){var e,n;if(DetectRTC.MediaDevices.forEach(function(o){"audioinput"===o.kind&&!1!==t.mediaConstraints.audio&&(e=o),"videoinput"===o.kind&&!1!==t.mediaConstraints.video&&(n=o)}),e){if("Firefox"===DetectRTC.browser.name)return void(!0!==t.mediaConstraints.audio?t.mediaConstraints.audio.deviceId=e.id:t.mediaConstraints.audio={deviceId:e.id});1==t.mediaConstraints.audio&&(t.mediaConstraints.audio={mandatory:{},optional:[]}),t.mediaConstraints.audio.optional||(t.mediaConstraints.audio.optional=[]);var o=[{sourceId:e.id}];t.mediaConstraints.audio.optional=o.concat(t.mediaConstraints.audio.optional)}if(n){if("Firefox"===DetectRTC.browser.name)return void(!0!==t.mediaConstraints.video?t.mediaConstraints.video.deviceId=n.id:t.mediaConstraints.video={deviceId:n.id});1==t.mediaConstraints.video&&(t.mediaConstraints.video={mandatory:{},optional:[]}),t.mediaConstraints.video.optional||(t.mediaConstraints.video.optional=[]);o=[{sourceId:n.id}];t.mediaConstraints.video.optional=o.concat(t.mediaConstraints.video.optional)}}),t.sdpConstraints={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},optional:[{VoiceActivityDetection:!1}]},t.sdpSemantics=null,t.iceCandidatePoolSize=null,t.bundlePolicy=null,t.rtcpMuxPolicy=null,t.iceTransportPolicy=null,t.optionalArgument={optional:[{DtlsSrtpKeyAgreement:!0},{googImprovedWifiBwe:!0},{googScreencastMinBitrate:300},{googIPv6:!0},{googDscp:!0},{googCpuUnderuseThreshold:55},{googCpuOveruseThreshold:85},{googSuspendBelowMinBitrate:!0},{googCpuOveruseDetection:!0}],mandatory:{}},t.iceServers=R.getIceServers(t),t.candidates={host:!0,stun:!0,turn:!0},t.iceProtocols={tcp:!0,udp:!0},t.onopen=function(e){t.enableLogs&&console.info("Data connection has been opened between you & ",e.userid)},t.onclose=function(e){t.enableLogs&&console.warn("Data connection has been closed between you & ",e.userid)},t.onerror=function(e){t.enableLogs&&console.error(e.userid,"data-error",e)},t.onmessage=function(e){t.enableLogs&&console.debug("data-message",e.userid,e.data)},t.send=function(e,n){t.peers.send(e,n)},t.close=t.disconnect=t.leave=function(){t.onbeforeunload(!1,!0)},t.closeEntireSession=function(e){e=e||function(){},t.socket.emit("close-entire-session",function n(){t.getAllParticipants().length?setTimeout(n,100):(t.onEntireSessionClosed({sessionid:t.sessionid,userid:t.userid,extra:t.extra}),t.changeUserId(null,function(){t.close(),e()}))})},t.onEntireSessionClosed=function(e){t.enableLogs&&console.info("Entire session is closed: ",e.sessionid,e.extra)},t.onstream=function(e){var n=t.videosContainer;n.insertBefore(e.mediaElement,n.firstChild);var o=e.mediaElement.play();void 0===o?setTimeout(function(){e.mediaElement.play()},2e3):o.catch(function(){}).then(function(){setTimeout(function(){e.mediaElement.play()},2e3)})},t.onstreamended=function(e){e.mediaElement||(e.mediaElement=document.getElementById(e.streamid)),e.mediaElement&&e.mediaElement.parentNode&&e.mediaElement.parentNode.removeChild(e.mediaElement)},t.direction="many-to-many",t.removeStream=function(e,n){var o;t.attachStreams.forEach(function(n){n.id===e&&(o=n)}),o?(t.peers.getAllParticipants().forEach(function(e){if(!n||e===n){var i=t.peers[e];try{i.peer.removeStream(o)}catch(e){}}}),t.renegotiate()):console.warn("No such stream exist.",e)},t.addStream=function(e,n){if(e.getTracks)return-1===t.attachStreams.indexOf(e)&&(e.streamid||(e.streamid=e.id),t.attachStreams.push(e)),void t.renegotiate(n);function o(o){e.streamCallback&&e.streamCallback(o),t.renegotiate(n)}l(e)?t.renegotiate(n):(e.audio||e.video||e.screen)&&(e.screen?"Edge"===DetectRTC.browser.name?navigator.getDisplayMedia({video:!0,audio:f(t)}).then(function(n){n.isScreen=!0,s.onGettingLocalMedia(n),!e.audio&&!e.video||f(t)?o(n):t.invokeGetUserMedia(null,function(e){o(e)})},function(e){console.error("Unable to capture screen on Edge. HTTPs and version 17+ is required.")}):t.invokeGetUserMedia({audio:f(t),video:!0,isScreen:!0},function(n){!e.audio&&!e.video||f(t)?o(n):t.invokeGetUserMedia(null,function(e){o(e)})}):(e.audio||e.video)&&t.invokeGetUserMedia(null,o))},t.invokeGetUserMedia=function(e,n,o){o||(o=t.session),e||(e=t.mediaConstraints),x({onGettingLocalMedia:function(t){var o=e.video;o&&(o.mediaSource||o.mozMediaSource?t.isScreen=!0:o.mandatory&&o.mandatory.chromeMediaSource&&(t.isScreen=!0)),t.isScreen||(t.isVideo=!!p(t,"video").length,t.isAudio=!t.isVideo&&p(t,"audio").length),s.onGettingLocalMedia(t,function(){"function"==typeof n&&n(t)})},onLocalMediaError:function(e,n){s.onLocalMediaError(e,n)},localMediaConstraints:e||{audio:!!o.audio&&e.audio,video:!!o.video&&e.video}})},t.applyConstraints=function(e,n){if(I&&I.prototype.applyConstraints){var o;if(n)return t.streamEvents[n]&&(o=t.streamEvents[n].stream),void y(o,e);t.attachStreams.forEach(function(n){y(n,e)})}else alert("track.applyConstraints is NOT supported in your browser.")},t.replaceTrack=function(e,n,o){if(e=e||{},C.prototype.getSenders)if(e instanceof I)E(e,n,o);else{if(e instanceof g)return p(e,"video").length&&E(p(e,"video")[0],n,!0),void(p(e,"audio").length&&E(p(e,"audio")[0],n,!1));if(l(e))throw"connection.replaceTrack requires audio and/or video and/or screen.";(e.audio||e.video||e.screen)&&(e.screen?"Edge"===DetectRTC.browser.name?navigator.getDisplayMedia({video:!0,audio:f(t)}).then(function(n){n.isScreen=!0,s.onGettingLocalMedia(n),!e.audio&&!e.video||f(t)?i(n):t.invokeGetUserMedia(null,i)},function(e){console.error("Unable to capture screen on Edge. HTTPs and version 17+ is required.")}):t.invokeGetUserMedia({audio:f(t),video:!0,isScreen:!0},!e.audio&&!e.video||f(t)?i:t.invokeGetUserMedia(null,i)):(e.audio||e.video)&&t.invokeGetUserMedia(null,i))}else t.addStream(e);function i(i){t.replaceTrack(i,n,o||e.video||e.screen)}},t.resetTrack=function(e,n){e||(e=t.getAllParticipants()),"string"==typeof e&&(e=[e]),e.forEach(function(e){var o=t.peers[e].peer;void 0!==n&&!0!==n||!o.lastVideoTrack||t.replaceTrack(o.lastVideoTrack,e,!0),void 0!==n&&!1!==n||!o.lastAudioTrack||t.replaceTrack(o.lastAudioTrack,e,!1)})},t.renegotiate=function(e){e?s.renegotiatePeer(e):t.peers.getAllParticipants().forEach(function(e){s.renegotiatePeer(e)})},t.setStreamEndHandler=function(e,n){if(e&&e.addEventListener&&(n=!!n,!e.alreadySetEndHandler)){e.alreadySetEndHandler=!0;var o="ended";"oninactive"in e&&(o="inactive"),e.addEventListener(o,function(){if(e.idInstance&&currentUserMediaRequest.remove(e.idInstance),!n){var o=[];t.attachStreams.forEach(function(n){n.id!=e.id&&o.push(n)}),t.attachStreams=o}var i=t.streamEvents[e.streamid];if(i||(i={stream:e,streamid:e.streamid,type:n?"remote":"local",userid:t.userid,extra:t.extra,mediaElement:t.streamEvents[e.streamid]?t.streamEvents[e.streamid].mediaElement:null}),n&&t.peers[i.userid]){var s=t.peers[i.userid].peer;o=[];s.getRemoteStreams().forEach(function(n){n.id!=e.id&&o.push(n)}),t.peers[i.userid].streams=o}i.userid===t.userid&&"remote"===i.type||(t.peersBackup[i.userid]&&(i.extra=t.peersBackup[i.userid].extra),t.onstreamended(i),delete t.streamEvents[e.streamid])},!1)}},t.onMediaError=function(e,n){t.enableLogs&&console.error(e,n)},t.autoCloseEntireSession=!1,t.filesContainer=t.videosContainer=document.body||document.documentElement,t.isInitiator=!1,t.shareFile=s.shareFile,void 0!==O&&O.handle(t),void 0!==D&&D.handle(t),t.token=a,t.onNewParticipant=function(e,n){t.acceptParticipationRequest(e,n)},t.acceptParticipationRequest=function(e,n){n.successCallback&&(n.successCallback(),delete n.successCallback),s.createNewPeer(e,n)},void 0!==A&&(t.StreamsHandler=A),t.onleave=function(e){},t.invokeSelectFileDialog=function(e){var n=new FileSelector;n.accept="*.*",n.selectSingleFile(e)},t.onmute=function(e){if(e&&e.mediaElement)if("both"===e.muteType||"video"===e.muteType){e.mediaElement.src=null;var n=e.mediaElement.pause();void 0!==n?n.then(function(){e.mediaElement.poster=e.snapshot||"https://cdn.webrtc-experiment.com/images/muted.png"}):e.mediaElement.poster=e.snapshot||"https://cdn.webrtc-experiment.com/images/muted.png"}else"audio"===e.muteType&&(e.mediaElement.muted=!0)},t.onunmute=function(e){e&&e.mediaElement&&e.stream&&("both"===e.unmuteType||"video"===e.unmuteType?(e.mediaElement.poster=null,e.mediaElement.srcObject=e.stream,e.mediaElement.play()):"audio"===e.unmuteType&&(e.mediaElement.muted=!1))},t.onExtraDataUpdated=function(e){e.status="online",t.onUserStatusChanged(e,!0)},t.getAllParticipants=function(e){return t.peers.getAllParticipants(e)},void 0!==A&&(A.onSyncNeeded=function(e,n,o){t.peers.getAllParticipants().forEach(function(t){s.onNegotiationNeeded({streamid:e,action:n,streamSyncNeeded:!0,type:o||"both"},t)})}),t.connectSocket=function(e){m(e)},t.closeSocket=function(){try{io.sockets={}}catch(e){}t.socket&&("function"==typeof t.socket.disconnect&&t.socket.disconnect(),"function"==typeof t.socket.resetProps&&t.socket.resetProps(),t.socket=null)},t.getSocket=function(e){return!e&&t.enableLogs&&console.warn("getSocket.callback paramter is required."),e=e||function(){},t.socket?e(t.socket):m(function(){e(t.socket)}),t.socket},t.getRemoteStreams=s.getRemoteStreams;var T=["selectFirst","selectAll","forEach"];if(t.streamEvents={selectFirst:function(e){return t.streamEvents.selectAll(e)[0]},selectAll:function(e){e||(e={local:!0,remote:!0,isScreen:!0,isAudio:!0,isVideo:!0}),"local"==e&&(e={local:!0}),"remote"==e&&(e={remote:!0}),"screen"==e&&(e={isScreen:!0}),"audio"==e&&(e={isAudio:!0}),"video"==e&&(e={isVideo:!0});var n=[];return Object.keys(t.streamEvents).forEach(function(o){var i=t.streamEvents[o];if(-1===T.indexOf(o)){var s=!0;e.local&&"local"===i.type&&(s=!1),e.remote&&"remote"===i.type&&(s=!1),e.isScreen&&i.stream.isScreen&&(s=!1),e.isVideo&&i.stream.isVideo&&(s=!1),e.isAudio&&i.stream.isAudio&&(s=!1),e.userid&&i.userid===e.userid&&(s=!1),!1===s&&n.push(i)}}),n}},t.socketURL="/",t.socketMessageEvent="RTCMultiConnection-Message",t.socketCustomEvent="RTCMultiConnection-Custom-Message",t.DetectRTC=DetectRTC,t.setCustomSocketEvent=function(e){e&&(t.socketCustomEvent=e),t.socket&&t.socket.emit("set-custom-socket-event-listener",t.socketCustomEvent)},t.getNumberOfBroadcastViewers=function(e,n){t.socket&&e&&n&&t.socket.emit("get-number-of-users-in-specific-broadcast",e,n)},t.onNumberOfBroadcastViewersUpdated=function(e){t.enableLogs&&t.isInitiator&&console.info("Number of broadcast (",e.broadcastId,") viewers",e.numberOfBroadcastViewers)},t.onUserStatusChanged=function(e,n){t.enableLogs&&!n&&console.info(e.userid,e.status)},t.getUserMediaHandler=x,t.multiPeersHandler=s,t.enableLogs=!0,t.setCustomSocketHandler=function(e){void 0!==o&&(o=e)},t.chunkSize=4e4,t.maxParticipantsAllowed=1e3,t.disconnectWith=s.disconnectWith,t.checkPresence=function(e,n){e=e||t.sessionid,"SSEConnection"!==o.name?t.socket?t.socket.emit("check-presence",e+"",function(e,o,i){t.enableLogs&&console.log("checkPresence.isRoomExist: ",e," roomid: ",o),n(e,o,i)}):t.connectSocket(function(){t.checkPresence(e,n)}):SSEConnection.checkPresence(e,function(e,o,i){if(!t.socket)return e||(t.userid=o),void t.connectSocket(function(){n(e,o,i)});n(e,o)})},t.onReadyForOffer=function(e,n){t.multiPeersHandler.createNewPeer(e,n)},t.setUserPreferences=function(e){return t.dontAttachStream&&(e.dontAttachLocalStream=!0),t.dontGetRemoteStream&&(e.dontGetRemoteStream=!0),e},t.updateExtraData=function(){t.socket.emit("extra-data-updated",t.extra)},t.enableScalableBroadcast=!1,t.maxRelayLimitPerUser=3,t.dontCaptureUserMedia=!1,t.dontAttachStream=!1,t.dontGetRemoteStream=!1,t.onReConnecting=function(e){t.enableLogs&&console.info("ReConnecting with",e.userid,"...")},t.beforeAddingStream=function(e){return e},t.beforeRemovingStream=function(e){return e},"undefined"!=typeof isChromeExtensionAvailable&&(t.checkIfChromeExtensionAvailable=isChromeExtensionAvailable),"undefined"!=typeof isFirefoxExtensionAvailable&&(t.checkIfChromeExtensionAvailable=isFirefoxExtensionAvailable),"undefined"!=typeof getChromeExtensionStatus&&(t.getChromeExtensionStatus=getChromeExtensionStatus),t.modifyScreenConstraints=function(e){return e},t.onPeerStateChanged=function(e){t.enableLogs&&-1!==e.iceConnectionState.search(/closed|failed/gi)&&console.error("Peer connection is closed between you & ",e.userid,e.extra,"state:",e.iceConnectionState)},t.isOnline=!0,c("online",function(){t.isOnline=!0}),c("offline",function(){t.isOnline=!1}),t.isLowBandwidth=!1,navigator&&navigator.connection&&navigator.connection.type&&(t.isLowBandwidth=-1!==navigator.connection.type.toString().toLowerCase().search(/wifi|cell/g),t.isLowBandwidth)){if(t.bandwidth={audio:!1,video:!1,screen:!1},t.mediaConstraints.audio&&t.mediaConstraints.audio.optional&&t.mediaConstraints.audio.optional.length){var M=[];t.mediaConstraints.audio.optional.forEach(function(e){void 0===e.bandwidth&&M.push(e)}),t.mediaConstraints.audio.optional=M}if(t.mediaConstraints.video&&t.mediaConstraints.video.optional&&t.mediaConstraints.video.optional.length){M=[];t.mediaConstraints.video.optional.forEach(function(e){void 0===e.bandwidth&&M.push(e)}),t.mediaConstraints.video.optional=M}}t.getExtraData=function(e,n){if(!e)throw"remoteUserId is required.";if("function"!=typeof n)return t.peers[e]?t.peers[e].extra:t.peersBackup[e]?t.peersBackup[e].extra:{};t.socket.emit("get-remote-user-extra-data",e,function(e,t,o){n(e,t,o)})},n.autoOpenOrJoin&&t.openOrJoin(t.sessionid),t.onUserIdAlreadyTaken=function(e,n){t.close(),t.closeSocket(),t.isInitiator=!1,t.userid=t.token(),t.join(t.sessionid),t.enableLogs&&console.warn("Userid already taken.",e,"Your new userid:",t.userid)},t.trickleIce=!0,t.version="3.6.9",t.onSettingLocalDescription=function(e){t.enableLogs&&console.info("Set local description for remote user",e.userid)},t.resetScreen=function(){sourceId=null,DetectRTC&&DetectRTC.screen&&delete DetectRTC.screen.sourceId,currentUserMediaRequest={streams:[],mutex:!1,queueRequests:[]}},t.autoCreateMediaElement=!0,t.password=null,t.setPassword=function(e,n){n=n||function(){},t.socket?t.socket.emit("set-password",e,n):(t.password=e,n(!0,t.sessionid,null))},t.onSocketDisconnect=function(e){t.enableLogs&&console.warn("socket.io connection is closed")},t.onSocketError=function(e){t.enableLogs&&console.warn("socket.io connection is failed")},t.errors={ROOM_NOT_AVAILABLE:"Room not available",INVALID_PASSWORD:"Invalid password",USERID_NOT_AVAILABLE:"User ID does not exist",ROOM_PERMISSION_DENIED:"Room permission denied",ROOM_FULL:"Room full",DID_NOT_JOIN_ANY_ROOM:"Did not join any room yet",INVALID_SOCKET:"Invalid socket",PUBLIC_IDENTIFIER_MISSING:"publicRoomIdentifier is required",INVALID_ADMIN_CREDENTIAL:"Invalid username or password attempted"}}(this)};"undefined"!=typeof module&&(module.exports=exports=RTCMultiConnection),"function"==typeof define&&define.amd&&define("RTCMultiConnection",[],function(){return RTCMultiConnection});var publicRoomIdentifier,connection,videoConnection,screenConnection,tenant,role,sessionId,sessionForChat,roomId,socket,streamConstraints,recentFile,conversationPanel,tempStream,RMCMediaTrack,lsDesigner,conferenceStyle,classVideo,videoElementContainer,videoWidgetContainer,roomLinkPage,forceClose=!1,autoReconnectInterval=5e3,popupNotifications=[],repeatStatInterval=2e3,visitorRinging=[],requirePassComm=!1,comController=function(){var e=this;this.init=function(n,t){requirePassComm="undefined"!=typeof passRoom&&passRoom,roomId=t,role=n,sessionId=getCookie("sessionId")&&"admin"!==getCookie("sessionId")?getCookie("sessionId"):getGuid();var o="admin"===role?"a":"";if(sessionForChat=getCookie("sessionForChat")?getCookie("sessionForChat"):sessionId+o,"admin"===role&&(sessionId="admin"),queryString.isAdmin&&(sessionId+="a"),setCookie("sessionId",sessionId,1),setCookie("sessionForChat",sessionForChat,1),window.enableAdapter=!0,publicRoomIdentifier="dashboard",tenant="dashboard",(connection=new RTCMultiConnection).iceServers=svConfigs.iceServers.iceServers,connection.socketURL=svConfigs.appWss,conferenceStyle=svConfigs.videoScreen&&"conference"===svConfigs.videoScreen.videoContainerStyle?"conference":"simple",classVideo="conference"===conferenceStyle?"sourcevideo":"bigvideo",videoElementContainer="conference"===conferenceStyle?"video_container_small":"video_container",videoWidgetContainer="conference"===conferenceStyle?"w.html":"widget.html",roomLinkPage="conference"==conferenceStyle?"r.html":"room.html",connection.publicRoomIdentifier=publicRoomIdentifier,connection.onbeforeunload=function(){},connection.session={audio:!1,video:!1,data:!0},"undefined"!=typeof names)var i=names[sessionId]?names[sessionId].name:guestName(sessionId);else i=guestName(sessionId);if(connection.extra={role:role,name:i,tenant:tenant,sessionId:sessionId,ua:navigator.userAgent,referrer:document.title,roomId:roomId,isAdmin:queryString.isAdmin||"admin"==role?1:0,pass:requirePassComm,callerInfo:localStorage.getItem("prd")?JSON.parse(localStorage.getItem("prd")):""},connection.onopen=function(e){if(console.log("You are connected with: "+connection.getAllParticipants().join(", ")),lsDesigner&&lsDesigner.pointsLength<=0&&setTimeout(function(){connection.send("plz-sync-points")},1e3),"popup"==e.extra.role)if(e.extra.isAdmin){var n=jQEngager.Event("AdminPopupOnline",{sessionId:e.extra.sessionId,isAdmin:1,pass:e.extra.pass});jQEngager(document).trigger(n)}else{if(e.extra.callerInfo)e={sessionId:e.extra.sessionId,isAdmin:e.extra.isAdmin,name:e.extra.callerInfo?e.extra.callerInfo.name:e.extra.name,callerInfo:e.extra.callerInfo,pass:e.extra.pass};else e=jQEngager.Event("PopupOnline",{sessionId:e.extra.sessionId,isAdmin:e.extra.isAdmin,pass:e.extra.pass});n=jQEngager.Event("PopupOnline",e);jQEngager(document).trigger(n)}if(e.extra&&"admin"==e.extra.role){n=jQEngager.Event("AdminOnline");jQEngager(document).trigger(n)}},connection.onclose=connection.onerror=connection.onleave=function(e){var n=jQEngager.Event("PopupLeft",{sessionId:e.userid,isAdmin:0});if(jQEngager(document).trigger(n),e.extra&&"admin"==e.extra.role){n=jQEngager.Event("AdminOffline");jQEngager(document).trigger(n)}e.extra&&"visitor"==e.extra.role&&(jQEngager("#simpleButton"+e.extra.sessionId).hide(),jQEngager("#chats-lsv-admin").remove("#simpleButton"+e.extra.sessionId)),console.log("On close",e)},connection.onUserStatusChanged=function(n){if("offline"==n.status){if(0==connection.getAllParticipants().length){var t=jQEngager.Event("AdminPopupOffline");jQEngager(document).trigger(t),e.handleCallTermination()}t=jQEngager.Event("PopupLeft",{sessionId:n.userid,isAdmin:0});jQEngager(document).trigger(t)}if("online"==n.status&&connection.getAllParticipants().length>0&&n.extra&&n.extra.sessionId!=sessionId){if(n.extra.callerInfo)n={sessionId:n.extra.sessionId,isAdmin:n.extra.isAdmin,name:n.extra.callerInfo?n.extra.callerInfo.name:n.extra.name,callerInfo:n.extra.callerInfo,pass:n.extra.pass};else n={sessionId:n.extra.sessionId,isAdmin:n.extra.isAdmin,pass:n.extra.pass};t=jQEngager.Event("PopupOnline",n);jQEngager(document).trigger(t)}},connection.onPeerStateChanged=function(e){if("closed"==e.iceConnectionState&&e.extra&&e.extra.isAdmin){var n=jQEngager.Event("AdminOffline");jQEngager(document).trigger(n);n=jQEngager.Event("AdminPopupOffline");jQEngager(document).trigger(n);for(var t=0;t<popupNotifications.length;t++)popupNotifications[t]==e.extra.sessionId&&popupNotifications.splice(t,1)}},this.onGettingWebRTCStats=function(e,n){videoConnection.peers[n]||e.nomore();bytesToSize(e.bandwidth.speed),e.encryption,e.audio.recv.codecs.concat(e.video.recv.codecs).join(", "),bytesToSize(e.audio.bytesReceived+e.video.bytesReceived),e.connectionType.remote.candidateType.join(", "),e.connectionType.remote.transport.join(", "),e.results.forEach(function(e){if("ssrc"===e.type&&"Channel-audio-1"===e.transportId){var n=e.packetsLost;e.packetsSent,e.audioInputLevel,e.googTrackId,e.mediaType,e.id.indexOf("_send");"\n","packetsLost: "+n}})},this.joinBroadcastLooper=function(){videoConnection.extra.broadcaster=!1,videoConnection.dontCaptureUserMedia=!0,videoConnection.session.oneway=!0,function e(){videoConnection.checkPresence(roomId+"_video",function(n,t,o){o._room&&o._room.isFull&&alert("Room is full."),n?videoConnection.join(roomId+"_video",function(e,n,t){t&&console.error("join",t,roomId+"_video")}):setTimeout(e,5e3)})}()},this.startScreenConnection=function(){(screenConnection=new RTCMultiConnection).closeBeforeUnload=!1,screenConnection.iceServers=svConfigs.iceServers.iceServers,screenConnection.socketURL=svConfigs.appWss,screenConnection.publicRoomIdentifier=publicRoomIdentifier,screenConnection.sdpConstraints.mandatory={OfferToReceiveAudio:!1,OfferToReceiveVideo:!0};var n={mandatory:{maxWidth:screen.width>1920?screen.width:1920,maxHeight:screen.height>1080?screen.height:1080},optional:[]};screenConnection.mediaConstraints=n,screenConnection.session={screen:!0,oneway:!0},screenConnection.onstream=function(e){if("local"===e.type)var n=document.getElementById("localScreen");else n=document.getElementById("remoteScreen");try{n.setAttributeNode(document.createAttribute("autoplay")),n.setAttributeNode(document.createAttribute("playsinline"))}catch(t){n.setAttribute("autoplay",!0),n.setAttribute("playsinline",!0)}if("local"===e.type){n.volume=0;try{n.setAttributeNode(document.createAttribute("muted"))}catch(t){n.setAttribute("muted",!0)}}else{var t=jQEngager.Event("RemoteScreenShareStarted");jQEngager(document).trigger(t)}n.srcObject=e.stream},screenConnection.onstreamended=function(n){var t=jQEngager.Event("ScreenShareEnded");jQEngager(document).trigger(t),e.handleScreenShareTermination()},screenConnection.onMediaError=function(n){if("Concurrent mic process limit."===n.message){if(DetectRTC.audioInputDevices.length<=1)return void alert("Please select external microphone. Check github issue number 483.");var t=DetectRTC.audioInputDevices[1].deviceId;screenConnection.mediaConstraints.audio={deviceId:t}}if("Permission denied"===n.message){n=jQEngager.Event("ScreenShareEnded");jQEngager(document).trigger(n),e.handleScreenShareTermination(),e.startScreenConnection()}}},connection.onmessage=function(n){if(!0!==n.data.typing)if(!1!==n.data.typing)if(n.data.chatMessage)if(n.data.privateId){if(n.data.privateId==e.getSessionId()){d=jQEngager.Event("ChatMessage",{msg:n.data.chatMessage,date:n.data.date,sessionId:n.data.sessionId,privateId:n.data.privateId});jQEngager(document).trigger(d)}if(n.data.privateId&&"admin"===role){jQEngager("#simpleButton"+n.data.privateId).show();var t=$("#contentChatsimple"+n.data.privateId)[0],o=$("#nameChat"+n.data.privateId).val();const e=`\n                                <div class="msg-lsv left-msg-lsv">\n                                  <div class="msg-lsv-bubble">\n                                    <div class="msg-lsv-info">\n                                      <div class="msg-lsv-info-name">${o}</div>\n                                      <div class="msg-lsv-info-time">${getPrettyDate((new Date).getTime()/1e3)}</div>\n                                    </div>\n\n                                    <div class="msg-lsv-text">${n.data.chatMessage}</div>\n                                  </div>\n                                </div>\n                              `;if(t.insertAdjacentHTML("beforeend",e),t.scrollTop+=500,playEnterRoom(),svConfigs.serverSide.chatHistory){var i=n.data.privateId,s=[];s[sessionForChat]={},s[i]={},saveChat(n.data.chatMessage,o,"",null,null,s)}}}else{d=jQEngager.Event("ChatMessage",{msg:n.data.chatMessage,date:n.data.date,sessionId:n.data.sessionId});jQEngager(document).trigger(d)}else if(n.data.translateMessage){d=jQEngager.Event("TranslateMessage",{msg:n.data.translateMessage,sessionId:n.data.sessionId});jQEngager(document).trigger(d)}else{if("voiceSpeaking"===n.data){d=jQEngager.Event("VoiceSpeaking",{id:n.userid});jQEngager(document).trigger(d)}if("voiceSilence"===n.data){d=jQEngager.Event("VoiceSilence",{id:n.userid});jQEngager(document).trigger(d)}if(lsDesigner&&"plz-sync-points"===n.data)lsDesigner.sync();else if(n.data.whiteboardData){d=jQEngager.Event("WhiteboardSync");if(jQEngager(document).trigger(d),queryString.isAdmin||localStorage.getItem("hasPrivileges")||e.startWhiteboard(),lsDesigner||e.startWhiteboard(),n.data.whiteboardData){var r=n.data.whiteboardData,a=screen.width/n.data.width;r.points.forEach(function(e){"text"==e[0]?(e[1][1]=e[1][1]*a,e[1][2]=e[1][2]*a):"image"==e[0]||"pdf"==e[0]?(e[1][1]=e[1][1]*a,e[1][2]=e[1][2]*a,e[1][3]=e[1][3]*a,e[1][4]=e[1][4]*a):(e[1][0]=e[1][0]*a,e[1][1]=e[1][1]*a,e[1][2]=e[1][2]*a,e[1][3]=e[1][3]*a)}),lsDesigner.syncData(r)}else lsDesigner.clearCanvas()}}else{var d=jQEngager.Event("SendTyping",{typing:!1});jQEngager(document).trigger(d)}else{var d=jQEngager.Event("SendTyping",{typing:!0,sessionId:n.userid});jQEngager(document).trigger(d)}},queryString.room){(videoConnection=new RTCMultiConnection).iceServers=svConfigs.iceServers.iceServers,videoConnection.socketURL=svConfigs.appWss,videoConnection.publicRoomIdentifier=publicRoomIdentifier,queryString.broadcast?videoConnection.sdpConstraints.mandatory={OfferToReceiveAudio:!0,OfferToReceiveVideo:!!queryString.isAdmin}:videoConnection.sdpConstraints.mandatory={OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},videoConnection.extra={sessionId:sessionId},videoConnection.onPeerStateChanged=function(e){},videoConnection.onspeaking=function(n){audio_on&&video_on&&e.getStream()&&connection.send("voiceSpeaking")},videoConnection.onsilence=function(e){connection.send("voiceSilence")},videoConnection.onMediaError=function(e){if("Permission denied"===e.message){e=jQEngager.Event("TogglePermissionDenied");jQEngager(document).trigger(e),socket.emit(connection.socketCustomEvent,{type:"endCall",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})}else videoConnection.openOrJoin(roomId+"_video",function(e,n,t){t&&console.error("openOrJoin",t,n)})},e.startScreenConnection(),connection.chunkSize=16e3,connection.enableFileSharing=!0,connection.onUserIdAlreadyTaken=function(e,n){},connection.autoSaveToDisk=!1;var s={};connection.onFileProgress=function(e,n){var t=s[e.uuid];t.progress[0].value=e.currentPosition||e.maxChunks||t.progress[0].max},connection.onFileStart=function(e){if(e.userid===connection.userid){if(!recentFile.started){recentFile.started=!0;var n=jQEngager.Event("IncomingFileTransfer",{name:e.name,sender:!0,fileId:e.uuid});jQEngager(document).trigger(n)}}else{n=jQEngager.Event("IncomingFileTransfer",{name:e.name,sender:!1,fileId:e.uuid});jQEngager(document).trigger(n)}s[e.uuid]={progress:jQEngager("#progress"+e.uuid)},s[e.uuid].progress.max=e.maxChunks},connection.onFileEnd=function(n){var t=e.getFileHTML(n);if(n.userid===connection.userid)if(recentFile){recentFile.userIndex++;var o=connection.getAllParticipants()[recentFile.userIndex];o?connection.send(recentFile,o):recentFile=null}else recentFile=null;else jQEngager("#download"+n.uuid).html(t)},videoConnection.onstream=function(n){if(console.log("videoConnection.onstream",n),videoConnection.videosContainer=document.getElementById(videoElementContainer),"local"===n.type){var t=jQEngager.Event("LocalVideoStarted");jQEngager(document).trigger(t),(i=document.getElementById("localVideo")).setAttribute("data-sessionId",n.extra.sessionId),i.muted=!0,i.volume=0,i.srcObject=n.stream}else{if(void 0===n.extra.sessionId)return;$(".sourcevideo").each(function(){$(this).attr("id"),n.extra.sessionId}),$(".bigvideo").each(function(){$(this).attr("id"),n.extra.sessionId});var o=document.getElementById("remoteVideoSpan"+n.extra.sessionId),i=document.getElementById(n.extra.sessionId);o&&o.remove(),i&&i.remove(),n.mediaElement.controls=!1,n.mediaElement.removeAttribute("src"),n.mediaElement.removeAttribute("srcObject");var s=document.createElement("video");s.id=n.extra.sessionId;var r=videoConnection.getAllParticipants().length;if(s.setAttribute("class",classVideo),"conference"!==conferenceStyle){var a=r>1?"49%":"98%",d=r>1?"relative":"absolute";s.style.width=a}try{s.setAttributeNode(document.createAttribute("autoplay")),s.setAttributeNode(document.createAttribute("playsinline")),s.setAttributeNode(document.createAttribute("videoautoplay"))}catch(t){s.playsinline=!0,s.autoplay=!0,s.videoautoplay=!0}var c=n.stream;if("srcObject"in s?s.srcObject=c:s[navigator.mozGetUserMedia?"mozSrcObject":"src"]=navigator.mozGetUserMedia?c:(window.URL||window.webkitURL).createObjectURL(c),videoConnection.videosContainer.appendChild(s),queryString.broadcast){t=jQEngager.Event("RemoteVideoStarted");jQEngager(document).trigger(t),queryString.token?toggleNotification(smartVideoLocale.msgStore.welcomeBroadcast,!0):toggleNotification(smartVideoLocale.msgStore.incomingBroadcast,!0);var u=s.play();void 0!==u&&u.then(function(){toggleNotification("",!1),s.play()}).catch(function(e){$("#incomingBroadcast").click(function(){toggleNotification("",!1),s.play()})})}else{t=jQEngager.Event("RemoteVideoStarted");jQEngager(document).trigger(t),s.play()}setTimeout(function(){$("."+classVideo).each(function(){$(this).is(":visible")&&($(this).css("width",a),$(this).css("position",d))})},100),setTimeout(function(){$("."+classVideo).each(function(){if($(this).is(":visible")){var e=$(this).attr("id");$("#remoteVideoSpan"+e).remove();var n=$(this).position(),t=jQEngager.Event("RemoteSpanPosition",{sessionId:e,position:n});jQEngager(document).trigger(t)}})},1e3),visitorRinging=[]}if(queryString.broadcast)if("remote"===n.type&&videoConnection.isInitiator){var l=[];videoConnection.getAllParticipants().forEach(function(e){l.push({pid:e,broadcaster:!0===videoConnection.peers[e].extra.broadcaster})}),videoConnection.socket.emit(videoConnection.socketCustomEvent,{participants:l})}else"remote"!==n.type||videoConnection.extra.broadcaster||videoConnection.socket.emit(videoConnection.socketCustomEvent,{giveAllParticipants:!0,roomId:roomId});videoConnection.onUserStatusChanged(n),0==svConfigs.videoScreen.videoConference&&setTimeout(function(){connection.send("voiceSpeaking")},1500),e.initHark({stream:n.stream,streamedObject:n,connection:videoConnection})},videoConnection.onstreamended=function(n){if(n.extra){var t=document.getElementById(n.extra.sessionId);t&&(t.parentNode.removeChild(t),$("#remoteVideoSpan"+n.extra.sessionId).remove());var o=videoConnection.getAllParticipants().length;if("conference"!==conferenceStyle)var i=o>1?"49%":"98%",s=o>1?"relative":"absolute";setTimeout(function(){$("."+classVideo).each(function(){$(this).is(":visible")&&($(this).css("width",i),$(this).css("position",s))})},100),setTimeout(function(){$("."+classVideo).each(function(){if($(this).is(":visible")){var e=$(this).attr("id");$("#remoteVideoSpan"+e).remove();var n=$(this).position(),t=jQEngager.Event("RemoteSpanPosition",{sessionId:e,position:n});jQEngager(document).trigger(t)}})},1e3),0===o&&e.handleCallTermination(),queryString.broadcast&&!connection.isInitiator&&(toggleError(smartVideoLocale.msgStore.broadcastStopped,5e3),location.reload())}},videoConnection.onUserStatusChanged=function(n){var t=[];connection.getAllParticipants().forEach(function(n){t.push(e.getFullName(n))}),t=t.length?[connection.extra.userFullName||"You"].concat(t):["Only You"],console.log("<b>Active users:</b> "+t.join(", "))},videoConnection.onopen=function(){console.log("You are connected with: "+connection.getAllParticipants().join(", "))},videoConnection.onclose=function(){videoConnection.getAllParticipants().length},videoConnection.onEntireSessionClosed=function(e){videoConnection&&(videoConnection.leave(),videoConnection.streamEvents.selectAll({local:!0}).forEach(function(e){e.stream.getAudioTracks()[0].stop(),e.stream.getVideoTracks()[0].stop()}));var n=jQEngager.Event("CallEnded");jQEngager(document).trigger(n)},"conference"==conferenceStyle&&(connection.autoCloseEntireSession=!1,videoConnection.autoCloseEntireSession=!1,screenConnection.autoCloseEntireSession=!1)}e.connect()},this.connect=function(){this.updateListOfRooms=function(n){jQEngager("#visitors").empty(),n.forEach(function(n,t){n.participants.forEach(function(t,o){var i=connection.peers[t];if(i){var s=i.extra,r=jQEngager("#visitors").find("#"+s.sessionId),a=s.ua?detect.parse(s.ua):"",d=a?a.browser.name:"",c=a?a.os.name:"",u=s.callerInfo&&s.callerInfo.name?s.callerInfo.name:guestName(s.sessionId),l='<a href="javascript:void(0);" id="chat'+s.sessionId+'">Start chat</a>',m='<section class="msger-lsv" id="simpleButton'+s.sessionId+'" style="display: none;">                            <header class="msger-lsv-header">                                <div class="msger-lsv-header-title">                                        '+u+'                                </div>                                <div class="msger-lsv-header-options">                                        <a href="javascript:void(0);" title="" class="close-but-wd-small" id="closeSimpleChat'+s.sessionId+'"><span></span></a>                                </div>                        </header>                        <main class="msger-lsv-chat" id="contentChatsimple'+s.sessionId+'">                        </main>                        <form class="msger-lsv-inputarea" id="form'+s.sessionId+'">                                <input type="text" id="input'+s.sessionId+'" class="msger-lsv-input" placeholder="Enter your message...">                                <input type="hidden" id="nameChat'+s.sessionId+'" value="'+u+'">                                <button type="submit" class="msger-lsv-send-btn">Send</button>                        </form>                </section>';if(r.length>0){var g=r[0];g.innerHTML='<div class="col-sm-10 col-xs-10">                                                                        <div class="messages msg_receive">                                                                                <p>'+u+" "+s.referrer+" "+l+"<br/>"+c+" "+d+"</p>                                                                                                                                                        </div>                                                                </div>",jQEngager(r[0]).replaceWith(g)}else l='<a href="javascript:void(0);" id="chat'+s.sessionId+'">Start chat</a>',(g=document.createElement("div")).className="row msg_container base_receive",g.id=s.sessionId,g.innerHTML='<div class="col-sm-10 col-xs-10">                                                                        <div class="messages msg_receive">                                                                                <p>'+u+" "+s.referrer+" "+l+"<br/>"+c+" "+d+"</p>                                                                                                                                                        </div>                                                                </div>",jQEngager("#visitors").append(g);if($("#chat"+s.sessionId).off("click"),$("#chat"+s.sessionId).click(function(){$("#simpleButton"+s.sessionId).show()}),0==jQEngager("#chats-lsv-admin").find("#simpleButton"+s.sessionId).length){jQEngager("#chats-lsv-admin").append(m),$("#chat"+s.sessionId).click(function(){$("#simpleButton"+s.sessionId).show()}),$("#closeSimpleChat"+s.sessionId).click(function(){$("#simpleButton"+s.sessionId).hide()});var f=function(e,n,t,o){if(!t)return;var i=$("#contentChatsimple"+s.sessionId)[0];const r=`\n                                <div class="msg-lsv ${n}-msg-lsv">\n                                  <div class="msg-lsv-bubble">\n                                    <div class="msg-lsv-info">\n                                      <div class="msg-lsv-info-name">${e}</div>\n                                      <div class="msg-lsv-info-time">${o||getPrettyDate((new Date).getTime()/1e3)}</div>\n                                    </div>\n\n                                    <div class="msg-lsv-text">${t}</div>\n                                  </div>\n                                </div>\n                              `;i.insertAdjacentHTML("beforeend",r),i.scrollTop+=500};$("#form"+s.sessionId).submit(function(n){n.preventDefault();var t=$("#input"+s.sessionId),o=t.val();if(f("Me","right",o),t.val(""),e.addLocalChat(o,null,s.sessionId),svConfigs.serverSide.chatHistory){var i=svConfigs.agentName?svConfigs.agentName:"Agent",r=s.sessionId,a=[];a[sessionForChat]={},a[r]={},saveChat(o,i,"",null,null,a)}}),svConfigs.serverSide.chatHistory&&$.ajax({type:"POST",url:lsRepUrl+"/server/script.php",data:{type:"getchat",roomId:roomId,sessionId:s.sessionId,agentId:null}}).done(function(e){e&&JSON.parse(e).forEach(function(e){var n=svConfigs.agentName?svConfigs.agentName:"Agent";if(e.from==n)var t="Me",o="right";else t=e.from,o="left";var i=getPrettyDate(e.date_created);f(t,o,e.message,i)})}).fail(function(){console.log(!1)})}if("popup"==n.extra.role){var p=jQEngager("#visitors").find("#"+s.sessionId),v=jQEngager("#visitors").find("#room"+s.sessionId);if(p.length>0&&0===v.length&&(setTimeout(function(){var e=p.children().children().children(),t={};t.names=svConfigs.agentName?svConfigs.agentName:guestName(s.sessionId),lsRepUrl&&(t.lsRepUrl=lsRepUrl),agentId&&(t.agentId=agentId);var o=window.btoa(JSON.stringify(t)),i=lsRepUrl+"pages/"+roomLinkPage+"?room="+n.extra.roomId+"&p="+o+"&isAdmin=1",r=document.createElement("span");r.id="room"+s.sessionId,r.innerHTML=' <a href="'+i+'" target="_blank">Enter Room</a>',e.append(r)},200),-1==jQEngager.inArray(s.sessionId,popupNotifications))){playEnterRoom();var h=jQEngager.Event("EnterPageNotification");jQEngager(document).trigger(h,{name:u}),popupNotifications.push(s.sessionId)}}}})})},this.looper=function(){connection.socket.emit("get-public-rooms",publicRoomIdentifier,function(n){e.updateListOfRooms(n),setTimeout(e.looper,3e3)})},connection.connectSocket(function(n){socket=n,connection.changeUserId(sessionId,null),e.showStatusBar("Connected to the chat server!",5e3);var t=jQEngager.Event("CommConnected");jQEngager(document).trigger(t),"admin"===role&&e.looper();socket.on("connect",function(n){e.showStatusBar("Connected to the chat server!",5e3)}),socket.on("disconnect",function(n){e.showStatusBar("Unable to connect to the chat server! Kindly refresh",1e4);var t=jQEngager.Event("AdminOffline");jQEngager(document).trigger(t),jQEngager("#visitors").empty(),location.reload()}),socket.on(connection.socketCustomEvent,function(e){if("initCall"===e.type&&sessionId!==e.sessionId&&e.roomId===roomId){connection.getAllParticipants().forEach(function(e){visitorRinging.push(e)});var n=jQEngager.Event("IncomingCall",{autoaccept:e.autoaccept,sessionId:e.sessionId});jQEngager(document).trigger(n)}if("startScreenShare"!==e.type||sessionId===e.sessionId||e.roomId!==roomId||screenConnection.isInitiator||screenConnection.extra.sessionId===sessionId||screenConnection.openOrJoin(roomId+"_screen",function(e,n,t){console.log(e,n,t),screenConnection.extra={sessionId:sessionId}}),"endCall"===e.type&&sessionId!==e.sessionId&&e.roomId===roomId&&setTimeout(function(){var n=visitorRinging.indexOf(e.sessionId);if(-1!==n&&visitorRinging.splice(n,1),0==videoConnection.getAllParticipants().length&&0==visitorRinging.length){var t=jQEngager.Event("CallEnded");jQEngager(document).trigger(t)}},200),"remoteVideoUnmuted"===e.type&&sessionId!==e.sessionId&&e.roomId===roomId){n=jQEngager.Event("RemoteVideoUnmuted",{sessionId:e.sessionId});jQEngager(document).trigger(n)}if("remoteVideoMuted"===e.type&&sessionId!==e.sessionId&&e.roomId===roomId){n=jQEngager.Event("RemoteVideoMuted",{sessionId:e.sessionId});jQEngager(document).trigger(n)}if("remoteAudioUnmuted"===e.type&&sessionId!==e.sessionId&&e.roomId===roomId){n=jQEngager.Event("RemoteAudioUnmuted",{sessionId:e.sessionId});jQEngager(document).trigger(n)}if("remoteAudioMuted"===e.type&&sessionId!==e.sessionId&&e.roomId===roomId){n=jQEngager.Event("RemoteAudioMuted",{sessionId:e.sessionId});jQEngager(document).trigger(n)}if("revokePriveleges"===e.type&&sessionId==e.sessionId&&e.roomId===roomId){n=jQEngager.Event("RevokePriveleges",{sessionId:e.sessionId});jQEngager(document).trigger(n)}if("grantPriveleges"===e.type&&sessionId==e.sessionId&&e.roomId===roomId){n=jQEngager.Event("GrantPriveleges",{sessionId:e.sessionId});jQEngager(document).trigger(n)}if("blockUser"===e.type&&e.roomId===roomId){n=jQEngager.Event("BlockUser",{sessionId:e.sessionId});jQEngager(document).trigger(n)}if("forceAudioMuted"===e.type&&e.roomId===roomId){n=jQEngager.Event("ForceAudioMuted",{sessionId:e.sessionId});jQEngager(document).trigger(n)}if("forceDelete"===e.type&&e.roomId===roomId){connection.leave();n=jQEngager.Event("ForceDelete",{sessionId:e.sessionId});jQEngager(document).trigger(n)}if("forceDeleteAll"===e.type&&sessionId!==e.sessionId&&e.roomId===roomId){connection.leave();n=jQEngager.Event("ForceDeleteAll");jQEngager(document).trigger(n)}if("setPresent"===e.type&&e.roomId===roomId){n=jQEngager.Event("SetPresent",{sessionId:e.sessionId,present:e.present});jQEngager(document).trigger(n)}if("endMeeting"===e.type&&e.roomId===roomId){n=jQEngager.Event("EndMeeting",{sessionId:e.sessionId});jQEngager(document).trigger(n)}if("adminOnline"===e.type&&e.roomId===roomId){n=jQEngager.Event("AdminOnline");jQEngager(document).trigger(n)}if("toVideo"===e.type&&sessionId!==e.sessionId&&e.roomId===roomId){n=jQEngager.Event("ToVideo");jQEngager(document).trigger(n)}if("startRecording"===e.type&&sessionId!==e.sessionId&&e.roomId===roomId){n=jQEngager.Event("RemoteStartRecording");jQEngager(document).trigger(n)}if("stopRecording"===e.type&&sessionId!==e.sessionId&&e.roomId===roomId){n=jQEngager.Event("RemoteStopRecording");jQEngager(document).trigger(n)}if("rejectCall"===e.type&&sessionId!==e.sessionId&&e.roomId===roomId){var t=visitorRinging.indexOf(e.sessionId);if(-1!==t&&visitorRinging.splice(t,1),0==visitorRinging.length){n=jQEngager.Event("CallEnded");jQEngager(document).trigger(n)}}if("setCallerInfo"===e.type&&sessionId!==e.sessionId&&e.roomId===roomId){n=jQEngager.Event("CallerInfo",{sessionId:e.sessionId,callerInfo:e.callerInfo,isAdmin:e.isAdmin});jQEngager(document).trigger(n)}if("clearCanvas"===e.type&&sessionId!==e.sessionId&&e.roomId===roomId&&lsDesigner&&lsDesigner.clearCanvas(),"sendCallerBack"===e.type&&e.roomId===roomId){n=jQEngager.Event("SendCallerBack",{access:e.access,sessionId:e.sessionId});jQEngager(document).trigger(n)}if(e.participants&&videoConnection&&!videoConnection.isInitiator&&!videoConnection.extra.broadcaster&&e.participants.forEach(function(e){e.pid!==videoConnection.userid&&-1===videoConnection.getAllParticipants().indexOf(e.pid)&&(videoConnection.extra.broadcaster||!1!==e.broadcaster)&&videoConnection.join(e.pid,function(e,n,t){})}),e.giveAllParticipants&&videoConnection&&videoConnection.isInitiator&&e.roomId==roomId){var o=[];videoConnection.getAllParticipants().forEach(function(e){o.push({pid:e,broadcaster:!0===videoConnection.peers[e].extra.broadcaster})}),connection.socket.emit(connection.socketCustomEvent,{participants:o}),toggleError(smartVideoLocale.msgStore.broadcastViewers+" "+o.length,5e3)}}),connection.checkPresence(roomId,function(e,n){!0===e?connection.join(roomId,function(e,n,t){queryString.isAdmin&&socket.emit(connection.socketCustomEvent,{type:"adminOnline",role:"popup",sessionId:sessionId,roomId:roomId}),console.log("joined to "+n),t&&location.reload()}):connection.open(roomId,function(e,n,t){queryString.isAdmin&&socket.emit(connection.socketCustomEvent,{type:"adminOnline",role:"popup",sessionId:sessionId,roomId:roomId}),console.log(e,n,t),t&&location.reload()}),"admin"===role&&(connection.isInitiator=!0)})})},this.renegotiate=function(e){navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:e}},audio:audio_on}).then(function(e){!function(e,n){n?videoConnection.lastCamera||(videoConnection.lastCamera=videoConnection.attachStreams[0]):videoConnection.lastCamera=e;videoConnection.getAllParticipants().forEach(function(n){var t=videoConnection.peers[n].peer;if(t.getSenders){var o=e.clone().getVideoTracks()[0],i=e.clone().getAudioTracks()[0];t.getSenders().forEach(function(e){console.log(e,e.track),e&&e.track&&("video"===e.track.kind&&o?(e.track.id!=o.id&&e.replaceTrack(o),o=null):"audio"===e.track.kind&&i&&(e.track.id!=i.id&&e.replaceTrack(i),i=null))})}})}(e)}),videoConnection.streamEvents.selectAll({local:!0}).forEach(function(e){e.stream.isAudio&&e.stream.getAudioTracks()[0].stop(),e.stream.isVideo&&e.stream.getVideoTracks()[0].stop()}),videoConnection.attachStreams.forEach(function(e){e.stop()}),streamConstraints={video:e?{deviceId:{exact:e}}:{facingMode:"user"},audio:audio_on},videoConnection.mediaConstraints=streamConstraints,videoConnection.session={video:!0,audio:audio_on},videoConnection.join(roomId+"_video")},this.initCall=function(n,t,o,i,s,r,a){videoConnection.extra.roomOwner=!0;var d=n||("initVideo"===this.id?"Video":"Audio"),c=s?{deviceId:{exact:s}}:{};audio_on||(c=!1),a&&jQEngager.extend(!0,c,a);var u=o?{deviceId:{exact:o}}:{facingMode:"user"};switch(r&&jQEngager.extend(!0,u,r),d){case"Video":var l=!0;streamConstraints={video:u,audio:c};break;case"Audio":l=!1,streamConstraints={audio:c,video:!1};break;default:l=!0,streamConstraints={video:u,audio:c}}if(queryString.broadcast)videoConnection.session={audio:!0,video:!!queryString.isAdmin,broadcast:!0},videoConnection.mediaConstraints={audio:!0,video:!!queryString.isAdmin},queryString.isAdmin||localStorage.getItem("hasPrivileges")?(videoConnection.extra.broadcaster=!0,videoConnection.openOrJoin(roomId+"_video",function(e,n,t){t&&console.error("openOrJoin",t,n)})):(videoConnection.extra.roomOwner=!1,e.joinBroadcastLooper());else{videoConnection.DetectRTC.load(function(){var n=[];if(videoConnection.DetectRTC.videoInputDevices.forEach(function(e){var t={};t.value=e.id,t.text=e.label,n.push(t)}),0===videoConnection.DetectRTC.videoInputDevices.length){var o=jQEngager.Event("VideoRemoved");jQEngager(document).trigger(o),socket.emit(connection.socketCustomEvent,{type:"remoteVideoMuted",role:role,tenant:tenant,sessionId:i,roomId:roomId})}if(0===videoConnection.DetectRTC.audioInputDevices.length){o=jQEngager.Event("AudioRemoved");jQEngager(document).trigger(o),socket.emit(connection.socketCustomEvent,{type:"remoteAudioMuted",role:role,tenant:tenant,sessionId:i,roomId:roomId})}if(videoConnection.DetectRTC.videoInputDevices){o=jQEngager.Event("MediaDevices",{devices:n});jQEngager(document).trigger(o)}streamConstraints.video=video_on?streamConstraints.video:streamConstraints.video=!1,streamConstraints.audio=audio_on?streamConstraints.audio:streamConstraints.audio=!1,videoConnection.mediaConstraints=streamConstraints,videoConnection.session={video:!!video_on&&l,audio:audio_on},videoConnection.checkPresence(roomId+"_video",function(n,o){if(!0===n?videoConnection.join(roomId+"_video",function(n,t,o){o&&(console.log(o),e.handleCallTermination(),videoConnection.closeEntireSession(function(){videoConnection.openOrJoin(roomId+"_video")}))}):videoConnection.open(roomId+"_video",function(n,t,o){o&&(console.log(o),e.handleCallTermination(),videoConnection.closeEntireSession(function(){videoConnection.openOrJoin(roomId+"_video")}))}),!video_on){var s=jQEngager.Event("LocalVideoStarted");jQEngager(document).trigger(s)}"simple"==conferenceStyle&&socket.emit(connection.socketCustomEvent,{type:"initCall",role:role,tenant:tenant,autoaccept:t,sessionId:i,roomId:roomId}),connection.getAllParticipants().forEach(function(e){visitorRinging.push(e)})})})}},this.leave=function(){connection.getAllParticipants().forEach(function(e){connection.disconnectWith(e)})},this.toggleAudio=function(){var e=1,n=1;videoConnection.attachStreams.forEach(function(t){t.getAudioTracks().forEach(function(t){e=t.enabled=!t.enabled,n=0})}),1==n&&(videoConnection.mediaConstraints.audio=!0,videoConnection.addStream({audio:!0}));var t=e?"AudioUnmuted":"AudioMuted",o=e?"remoteAudioUnmuted":"remoteAudioMuted",i=jQEngager.Event(t);jQEngager(document).trigger(i),socket.emit(connection.socketCustomEvent,{type:o,role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.toggleVideo=function(){var e=1,n=1;videoConnection.attachStreams.forEach(function(t){t.getVideoTracks().forEach(function(t){e=t.enabled=!t.enabled,n=0})}),1==n&&(videoConnection.mediaConstraints.video=!0,videoConnection.addStream({video:!0}));var t=e?"VideoUnmuted":"VideoMuted",o=e?"remoteVideoUnmuted":"remoteVideoMuted",i=jQEngager.Event(t);jQEngager(document).trigger(i),socket.emit(connection.socketCustomEvent,{type:o,role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.answerCall=function(n,t,o,i,s,r){var a=i?{deviceId:{exact:i}}:{};if(r&&jQEngager.extend(!0,a,r),n)var d=o?{deviceId:{exact:o}}:{facingMode:"user"};else d=!1;s&&jQEngager.extend(!0,d,s),streamConstraints={video:d,audio:a},videoConnection.session={video:n,audio:!0},videoConnection.mediaConstraints=streamConstraints,t&&setTimeout(function(){videoConnection.openOrJoin(roomId+"_video",function(n,t,o){o&&(console.log(o),e.handleCallTermination(),location.reload())})},200)},this.forceStopCall=function(e){videoConnection.streamEvents.selectAll({local:!0}).forEach(function(e){e.stream.isAudio&&e.stream.getAudioTracks()[0].stop(),e.stream.isVideo&&e.stream.getVideoTracks()[0].stop()}),videoConnection.attachStreams.forEach(function(e){e.stop()}),videoConnection.leave(),videoConnection.closeSocket(),streamConstraints={video:e?{deviceId:{exact:e}}:{facingMode:"user"},audio:audio_on},videoConnection.mediaConstraints=streamConstraints,videoConnection.session={video:video_on,audio:audio_on},videoConnection.join(roomId+"_video",function(e,n,t){setTimeout(function(){videoConnection.getAllParticipants().forEach(function(e){var n,t,o=videoConnection.peers[e].peer;o.getSenders&&(videoConnection.streamEvents.selectAll({local:!0}).forEach(function(e){e.stream.isAudio&&(t=e.stream.getAudioTracks()[0]),e.stream.isVideo&&(n=e.stream.getVideoTracks()[0])}),o.getSenders().forEach(function(e){e&&e.track&&("video"===e.track.kind&&n?(e.track.id!=n.id&&e.replaceTrack(n),n=null):"audio"===e.track.kind&&t&&(e.track.id!=t.id&&e.replaceTrack(t),t=null))}))})},1e3)})},this.handleCallTermination=function(){videoConnection&&"conference"!=conferenceStyle&&(videoConnection.streamEvents.selectAll({local:!0}).forEach(function(e){e.stream.isAudio&&e.stream.getAudioTracks()[0].stop(),e.stream.isVideo&&e.stream.getVideoTracks()[0].stop()}),videoConnection.attachStreams.forEach(function(e){e.stop()}),0==videoConnection.getAllParticipants().length?videoConnection.closeSocket():videoConnection.leave())},this.reconnectWebsocket=function(n){forceClose||(console.log("WebSocketClient reconnecting in "+autoReconnectInterval,n),setTimeout(function(){console.log("WebSocketClient: reconnecting..."),e.connect()},autoReconnectInterval))},this.getRoomId=function(){return roomId},this.checkMediaDevices=function(){videoConnection.DetectRTC.load(function(){var e=[];videoConnection.DetectRTC.videoInputDevices.forEach(function(n){var t={};t.value=n.id,t.text=n.label,e.push(t)});var n=jQEngager.Event("MediaDevices",{devices:e});jQEngager(document).trigger(n)})},this.getParticipants=function(){return connection.getAllParticipants()},this.getVideoSessions=function(){return videoConnection?videoConnection.getAllParticipants().length:0},this.addStreamStopListener=function(e,n){e.addEventListener("ended",function(){n(),n=function(){}},!1),e.addEventListener("inactive",function(){n(),n=function(){}},!1),e.getTracks().forEach(function(e){e.addEventListener("ended",function(){n(),n=function(){}},!1),e.addEventListener("inactive",function(){n(),n=function(){}},!1)})},this.addToJoinScreenShare=function(){screenConnection&&screenConnection.isInitiator&&socket.emit(connection.socketCustomEvent,{type:"startScreenShare",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.startScreenShare=function(){screenConnection.openOrJoin(roomId+"_screen",function(e,n,t){screenConnection.isInitiator=!0,screenConnection.extra={sessionId:sessionId},socket.emit(connection.socketCustomEvent,{type:"startScreenShare",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})})},this.rejectCall=function(){socket.emit(connection.socketCustomEvent,{type:"rejectCall",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.stopRecording=function(){},this.getSessionId=function(){return sessionId},this.getRemoteSessionId=function(){return""},this.getVideoStream=function(){var e=!1;return videoConnection?videoConnection.attachStreams.forEach(function(n){n.getVideoTracks().forEach(function(n){e=n.enabled})}):e=!1,e},this.getStream=function(){return!!videoConnection&&videoConnection.getAllParticipants().length>0},this.getRemoteStream=function(e){var n;return videoConnection&&Object.keys(videoConnection.streamEvents).forEach(function(t){var o=videoConnection.streamEvents[t];if(o.stream&&o.extra.sessionId==e)return n=o.stream,!1}),n},this.endCall=function(e){socket.emit(connection.socketCustomEvent,{type:"endCall",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId,msg:e}),videoConnection&&(videoConnection.streamEvents.selectAll({local:!0}).forEach(function(e){e.stream.isAudio&&e.stream.getAudioTracks()[0].stop(),e.stream.isVideo&&e.stream.getVideoTracks()[0].stop()}),videoConnection.leave())},this.setMute=function(e){socket.emit(connection.socketCustomEvent,{type:"forceAudioMuted",role:role,tenant:tenant,sessionId:e,roomId:roomId})},this.forceAudioMute=function(){var e=videoConnection.attachStreams[0];e&&e.mute("audio");var n=jQEngager.Event("AudioMuted");jQEngager(document).trigger(n),socket.emit(connection.socketCustomEvent,{type:"remoteAudioMuted",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.setDelete=function(e){socket.emit(connection.socketCustomEvent,{type:"forceDelete",role:role,tenant:tenant,sessionId:e,roomId:roomId})},this.setClose=function(){forceClose=!0,connection.closeEntireSession()},this.setPresentUser=function(e,n){socket.emit(connection.socketCustomEvent,{type:"setPresent",role:role,tenant:tenant,present:n,sessionId:e,roomId:roomId})},this.setDeleteAll=function(e){socket.emit(connection.socketCustomEvent,{type:"forceDeleteAll",role:role,tenant:tenant,sessionId:e,roomId:roomId})},this.revokePriveleges=function(e){socket.emit(connection.socketCustomEvent,{type:"revokePriveleges",role:role,tenant:tenant,sessionId:e,roomId:roomId})},this.blockUser=function(e){socket.emit(connection.socketCustomEvent,{type:"blockUser",role:role,tenant:tenant,sessionId:e,roomId:roomId})},this.endMeeting=function(e){socket.emit(connection.socketCustomEvent,{type:"endMeeting",role:role,tenant:tenant,sessionId:e,roomId:roomId})},this.toVideo=function(){socket.emit(connection.socketCustomEvent,{type:"toVideo",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.grantPriveleges=function(e){socket.emit(connection.socketCustomEvent,{type:"grantPriveleges",role:role,tenant:tenant,sessionId:e,roomId:roomId})},this.getScreenStream=function(){return!!screenConnection&&screenConnection.attachStreams.length>0},this.startRecording=function(){socket.emit(connection.socketCustomEvent,{type:"startRecording",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.stopRecording=function(){socket.emit(connection.socketCustomEvent,{type:"stopRecording",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.setCallerInfo=function(e,n){socket.emit(connection.socketCustomEvent,{type:"setCallerInfo",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId,callerInfo:e,isAdmin:n}),connection.extra={role:role,name:name,tenant:tenant,sessionId:sessionId,roomId:roomId,isAdmin:queryString.isAdmin||"admin"==role?1:0,pass:requirePassComm,callerInfo:e}},this.sendCallerBack=function(e,n){socket.emit(connection.socketCustomEvent,{type:"sendCallerBack",role:role,tenant:tenant,sessionId:n,roomId:roomId,access:e})},this.handleScreenShareTermination=function(){screenConnection&&(screenConnection&&screenConnection.streamEvents.selectAll({local:!0}).forEach(function(e){e.stream.getVideoTracks()[0].stop()}),screenConnection.attachStreams.forEach(function(e){e.stop()}),screenConnection.isInitiator=!1,screenConnection.extra={sessionId:null},screenConnection.closeSocket())},this.addLocalChat=function(e,n,t){e&&e.replace(/ /g,"").length&&(connection.send({chatMessage:e,privateId:t,date:n,sessionId:sessionId}),connection.send({typing:!1}))},this.sendTranslateMessage=function(e){e&&e.replace(/ /g,"").length&&connection.send({translateMessage:e,sessionId:sessionId})},this.sendTyping=function(e){e?connection.send({typing:!0}):connection.send({typing:!1})},this.getFileHTML=function(e){return'<a href="'+(e.url||URL.createObjectURL(e))+'" target="_blank" download="'+e.name+'">Download: <b>'+e.name+"</b></a>"},this.getFullName=function(e){var n=e;return connection.peers[e]&&connection.peers[e].extra&&connection.peers[e].extra.userFullName&&(n=connection.peers[e].extra.userFullName),n},this.sendFile=function(e){recentFile=e,connection.getAllParticipants().length>=1&&(recentFile.userIndex=0,connection.send(recentFile,connection.getAllParticipants()[recentFile.userIndex]))},this.setWhiteboardTools=function(){lsDesigner&&(lsDesigner.destroy(),lsDesigner=null),e.startWhiteboard()},this.whiteboardTools=function(){lsDesigner.setSelected("pencil"),lsDesigner.setTools({line:!0,arrow:!0,pencil:!0,marker:!0,dragSingle:!0,dragMultiple:!0,eraser:!0,pdf:!0,rectangle:!0,arc:!0,text:!0,image:!0,zoom:!0,lineWidth:!0,colorsPicker:!0,extraOptions:!0,undo:!0}),lsDesigner.icons={pencil:lsRepUrl+"img/whiteboard/pencil.png",marker:lsRepUrl+"img/whiteboard/brush.png",eraser:lsRepUrl+"img/whiteboard/eraser.png",text:lsRepUrl+"img/whiteboard/text.png",image:lsRepUrl+"img/whiteboard/image.png",dragSingle:lsRepUrl+"img/whiteboard/dragSingle.png",dragMultiple:lsRepUrl+"img/whiteboard/dragMultiple.png",line:lsRepUrl+"img/whiteboard/line.png",arrow:lsRepUrl+"img/whiteboard/arrow.png",pdf:lsRepUrl+"img/whiteboard/pdf.png",zoom_in:lsRepUrl+"img/whiteboard/zoom_in.png",zoom_out:lsRepUrl+"img/whiteboard/zoom_out.png",arc:lsRepUrl+"img/whiteboard/arc.png",rectangle:lsRepUrl+"img/whiteboard/rectangle.png",lineWidth:lsRepUrl+"img/whiteboard/lineWidth.png",undo:lsRepUrl+"img/whiteboard/undo.png",colorsPicker:lsRepUrl+"img/whiteboard/colorsPicker.png",extraOptions:lsRepUrl+"img/whiteboard/extraOptions.png"}},this.initHark=function(e){if(!window.hark)throw"Please link hark.js";var n=e.connection,t=e.streamedObject,o=e.stream,i=hark(o,{});i.on("speaking",function(){n.onspeaking(t)}),i.on("stopped_speaking",function(){n.onsilence(t)})},this.startWhiteboard=function(){if(!lsDesigner){(lsDesigner=new CanvasDesigner).widgetHtmlURL=lsRepUrl+"pages/whiteboard.html",lsDesigner.widgetJsURL=lsRepUrl+"js/whiteboard.widget.js",queryString.isAdmin||svConfigs.whiteboard.allowAnonymous||localStorage.getItem("hasPrivileges")?(e.whiteboardTools(),lsDesigner.addSyncListener(function(e){connection.send({width:screen.width,whiteboardData:e})})):(lsDesigner.setTools({}),lsDesigner.setSelected("")),lsDesigner.pointsLength<=0&&setTimeout(function(){connection.send("plz-sync-points")},1e3);var n=document.getElementById("whiteboard_canvas");lsDesigner.appendTo(n)}setTimeout(function(){lsDesigner.sync()},2e3)},this.clearCanvas=function(){lsDesigner&&(lsDesigner.clearCanvas(),socket.emit(connection.socketCustomEvent,{type:"clearCanvas",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId}))},this.showStatusBar=function(e,n){console.log("showStatusBar",e),jQEngager("#statusbar").html(e),jQEngager("#statusbar").show(),setTimeout(function(){jQEngager("#statusbar").hide()},n)}};